<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hunter Database | HxH RPG</title>
    
    <!-- SEO & Icons -->
    <meta name="description" content="Ficha de RPG Hunter x Hunter interativa. Gerencie atributos, Nen, invocações e inventário com cálculos automáticos.">
    <meta name="theme-color" content="#050506">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&family=Shojumaru&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser JSX/TS transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'hxh-dark': '#0a0a0c',
              'hxh-panel': '#131316',
              'theme': 'var(--theme-color)',
            },
            fontFamily: {
              'title': ['Shojumaru', 'cursive'],
              'header': ['Cinzel', 'serif'],
              'tech': ['Orbitron', 'sans-serif'],
              'body': ['Lato', 'sans-serif'],
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out forwards',
              'blink': 'blink 2s step-end infinite',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' }
              },
              blink: {
                '0%, 100%': { opacity: '1' },
                '50%': { opacity: '0.3' }
              }
            }
          }
        }
      }
    </script>
    
    <style>
      :root {
        --theme-color: #9b59b6;
      }
      body {
        background-color: #050506;
        color: #e0e0e0;
        overflow-x: hidden;
      }
      
      /* Decorative Background Pattern */
      .bg-hunter-pattern {
        background-color: #050506;
        background-image: 
            radial-gradient(circle at 50% 50%, rgba(var(--theme-color), 0.05) 0%, transparent 50%),
            linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 100% 100%, 30px 30px, 30px 30px;
        background-position: center, center, center;
      }

      .glass-panel {
        background: rgba(19, 19, 22, 0.85);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Tech Border Decoration */
      .tech-border {
        position: relative;
        border: 1px solid rgba(255,255,255,0.08);
        transition: all 0.3s ease;
      }
      .tech-border::before, .tech-border::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        border-color: var(--theme-color);
        border-style: solid;
        transition: all 0.3s ease;
        opacity: 0.6;
        pointer-events: none; /* CRITICAL FIX: Allows clicks to pass through decorations */
        z-index: 0;
      }
      .tech-border::before { top: 0; left: 0; border-width: 1px 0 0 1px; }
      .tech-border::after { bottom: 0; right: 0; border-width: 0 1px 1px 0; }
      
      .tech-border:hover { 
        border-color: rgba(255,255,255,0.15); 
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
      }
      .tech-border:hover::before, .tech-border:hover::after {
        width: 100%;
        height: 100%;
        opacity: 0.1;
      }

      .avatar-frame {
        clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        position: relative;
      }
      .avatar-frame::after {
        content: '';
        position: absolute;
        inset: 0;
        border: 1px solid rgba(255,255,255,0.1);
        clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        pointer-events: none;
      }

      /* Input Reset for cleaner Edit Mode */
      input, textarea, select {
        background: transparent;
        color: inherit;
        border: none;
        outline: none;
        transition: all 0.2s;
      }
      
      /* Edit Mode Styling */
      .edit-mode input, .edit-mode textarea, .edit-mode select {
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        border-radius: 2px 2px 0 0;
        padding: 2px 4px;
      }
      .edit-mode input:focus, .edit-mode textarea:focus, .edit-mode select:focus {
        background: rgba(255, 255, 255, 0.05);
        border-bottom-color: var(--theme-color);
      }

      /* Scrollbar Hiding for clean Tabs */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      /* Custom Scrollbar for content */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--theme-color); }

      .license-pattern {
         background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react, typescript" data-type="module">
      import React, { useState, useRef, useEffect } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { 
        Shield, Zap, Heart, Sword, Brain, Activity, Ghost, Feather, Dna, 
        Dice5, Trash2, Edit3, Save, Plus, X, Camera, ScrollText, Box,
        Users, Upload, Share2, Copy, Hexagon,
        Monitor, Target, PawPrint, Terminal, ChevronRight, ImageIcon, BatteryCharging, Sparkles,
        AlertCircle, Calculator, Info, Lock
      } from 'https://esm.sh/lucide-react@0.294.0';

      const utf8_to_b64 = (str) => window.btoa(unescape(encodeURIComponent(str)));
      const b64_to_utf8 = (str) => decodeURIComponent(escape(window.atob(str)));
      
      const rollDice = (diceStr) => {
        try {
            if(!diceStr) return 0;
            const [count, die] = diceStr.toLowerCase().split('d').map(Number);
            if(!count || !die) return 0;
            let total = 0;
            let rolls = [];
            for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * die) + 1;
                rolls.push(r);
                total += r;
            }
            return { total, rolls, str: diceStr };
        } catch (e) { return { total: 0, rolls: [], str: diceStr }; }
      };

      const resizeImage = (file, maxWidth = 600) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = (error) => reject(error);
            };
            reader.onerror = (error) => reject(error);
        });
      };

      const NenType = {
        Enhancer: 'Reforço',
        Transmuter: 'Transformação',
        Emitter: 'Emissão',
        Conjurer: 'Materialização',
        Manipulator: 'Manipulação',
        Specialist: 'Especialização',
      };

      const NEN_COLORS = {
        [NenType.Enhancer]: '#2ecc71', 
        [NenType.Transmuter]: '#d500f9', 
        [NenType.Emitter]: '#29b6f6',
        [NenType.Conjurer]: '#ff1744', 
        [NenType.Manipulator]: '#ff6d00',
        [NenType.Specialist]: '#ffea00',
      };

      const INITIAL_CHARACTER = {
        id: 'char_default',
        name: "Cristian Martínez",
        nickname: "'Hades'",
        avatarUrl: "https://i.pinimg.com/736x/8e/46/64/8e4664440076a084c7873994c657a827.jpg", 
        age: 18,
        nationality: "Peruano",
        height: "1.72 m",
        weight: "64 kg",
        alignment: "Neutro-Neutro",
        bio: "Hades cresceu nas ruas de Meteor City...",
        hunterLevel: 5,
        xp: 250,
        maxXp: 600,
        nenType: NenType.Specialist, 
        maxHp: 34, currentHp: 34, maxNen: 58, currentNen: 33, ca: 15,
        attributes: { strength: -2, constitution: -2, intelligence: 0, charisma: -3, determination: 3, prestidigitation: 5 },
        attributeLabels: { strength: 'Força', constitution: 'Constituição', intelligence: 'Inteligência', charisma: 'Carisma', determination: 'Determinação', prestidigitation: 'Destreza' },
        equippedWeapon: { name: 'Foice de Nen', damage: '1d10', description: 'Uma foice materializada que drena aura.', powers: 'Ao acertar um crítico, recupera 1d4 de Nen.', imageUrl: '' },
        skills: [
            { id: '1', name: 'Força de Pulso', category: 'Weapon', type: 'Ativa', cost: 2, costType: 'Nen', damageDice: '1d8', attributeScaling: 'determination', description: 'Golpeia o ar criando uma onda de choque.', imageUrl: 'https://i.pinimg.com/564x/4d/2e/77/4d2e77987823e595df5057a151859c2c.jpg' },
            { id: '2', name: 'Passo Sombrio', category: 'Combat', type: 'Bônus', cost: 0, costType: 'Nen', damageDice: '2d6', attributeScaling: 'prestidigitation', description: 'Movimentação silenciosa. Vantagem no ataque.', imageUrl: '' },
            { id: '3', name: 'Sacrifício de Sangue', category: 'Hatsu', type: 'Ativa', cost: 5, costType: 'HP', damageDice: '3d6', attributeScaling: '', description: 'Sacrifica vitalidade para causar dano massivo.', imageUrl: '' },
        ],
        inventory: [
            { id: 'i1', name: "Espada Curta", quantity: 1 },
            { id: 'i2', name: "Poção de Cura", quantity: 2 },
            { id: 'i3', name: "Licença Hunter", quantity: 1 }
        ],
        summons: [
             { id: 's1', name: 'Guardião Sombrio', avatarUrl: 'https://i.pinimg.com/564x/0a/65/59/0a6559385b0451df6718d09794025171.jpg', type: 'Besta de Nen', currentHp: 20, maxHp: 20, currentNen: 10, maxNen: 10, attributes: { strength: 3, constitution: 2, intelligence: -2, charisma: -3, determination: 4, prestidigitation: 2 }, description: 'Um lobo feito de sombras.', skills: [
                 { id: 's1k1', name: 'Mordida Sombria', cost: 2, costType: 'Nen', damage: '1d6', description: 'Ataque rápido com as presas.' }
             ] }
        ],
        conditions: ['Ren', 'Furtividade']
      };

      // --- COMPONENTS ---

      const StatBar = ({ label, current, max, color, icon, isEditing, onChange, onMaxChange, onOpenCalculator }) => {
        const percentage = Math.min(100, Math.max(0, (current / max) * 100));
        return (
            <div className="flex flex-col w-full mb-4 group relative z-10">
                <div className="flex justify-between items-end mb-1.5">
                    <div className="flex items-center gap-2 text-white font-tech text-xs font-bold uppercase tracking-wider opacity-90">
                        {icon && <span style={{color, filter: `drop-shadow(0 0 5px ${color})`}}>{icon}</span>}
                        <span className="text-gray-300 group-hover:text-white transition-colors">{label}</span>
                    </div>
                    <div className="flex items-center text-lg font-bold font-mono">
                        {!isEditing && (
                            <button onClick={onOpenCalculator} className="mr-3 text-gray-500 hover:text-white transition-colors opacity-50 hover:opacity-100 z-20 relative" title="Calculadora de Dano/Cura">
                                <Calculator size={14} />
                            </button>
                        )}
                        <input type="number" value={current} onChange={(e) => onChange && onChange(parseInt(e.target.value) || 0)} className="w-14 bg-transparent text-right outline-none hover:text-white text-gray-200 font-bold border-b border-transparent focus:border-white/50 relative z-20" />
                        <span className="mx-1 text-gray-600">/</span>
                        {isEditing ? <input type="number" value={max} onChange={(e) => onMaxChange && onMaxChange(parseInt(e.target.value) || 0)} className="w-14 bg-white/5 rounded px-1 text-center outline-none border border-white/10 text-white relative z-20"/> : <span className="text-gray-500 w-14 text-center">{max}</span>}
                    </div>
                </div>
                {/* Custom Bar Design */}
                <div className="relative h-3 bg-[#050506] border border-white/10 mx-0.5 rounded-sm overflow-hidden">
                     {/* Background Grid inside bar */}
                    <div className="absolute inset-0 bg-[linear-gradient(90deg,transparent_2px,rgba(255,255,255,0.05)_2px)] bg-[length:10px_100%] z-0 pointer-events-none"></div>
                    <div className="h-full transition-all duration-700 relative z-10" style={{ width: `${percentage}%`, backgroundColor: color, boxShadow: `0 0 15px ${color}80` }}>
                        <div className="absolute top-0 right-0 bottom-0 w-[1px] bg-white/50"></div>
                    </div>
                </div>
            </div>
        );
      };

      const CalculatorModal = ({ isOpen, onClose, target, onConfirm }) => {
          const [value, setValue] = useState('');
          useEffect(() => { if (isOpen) setValue(''); }, [isOpen]);
          if (!isOpen || !target) return null;

          const handleApply = (type) => {
              const numVal = parseInt(value) || 0;
              if (numVal === 0) return;
              onConfirm(type === 'sub' ? -numVal : numVal);
              onClose();
          };
          const isHp = target.field.toLowerCase().includes('hp');
          
          return (
            <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fade-in" style={{zIndex: 110}}>
                <div className="glass-panel w-full max-w-xs p-6 tech-border relative flex flex-col items-center">
                    <button onClick={onClose} className="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors z-20"><X size={20}/></button>
                    <h3 className="text-xs font-tech text-theme uppercase tracking-[0.2em] mb-2">{target.label}</h3>
                    
                    <div className="text-4xl font-mono font-bold text-white mb-6 flex items-baseline gap-2">
                        <span>{target.current}</span>
                        <span className="text-lg text-gray-600">/</span>
                        <span className="text-lg text-gray-500">{target.max}</span>
                    </div>

                    <div className="w-full bg-black/50 border border-white/10 p-3 mb-6 flex items-center justify-center rounded relative z-10">
                         <input type="number" autoFocus placeholder="0" className="bg-transparent text-center text-4xl font-mono text-white w-full placeholder-gray-800 focus:outline-none"
                            value={value} onChange={(e) => setValue(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleApply('sub'); }} />
                    </div>

                    <div className="flex gap-2 mb-6 w-full justify-center relative z-10">
                        {[1, 5, 10, 50].map(v => (
                            <button key={v} onClick={() => setValue(v)} className="bg-white/5 hover:bg-white/20 border border-white/10 text-xs font-mono py-1.5 px-3 rounded text-gray-400 hover:text-white transition-colors">{v}</button>
                        ))}
                    </div>

                    <div className="grid grid-cols-2 gap-4 w-full relative z-10">
                        <button onClick={() => handleApply('sub')} className={`py-3.5 ${isHp ? 'bg-red-900/20 hover:bg-red-900/40 border-red-500/30 text-red-400' : 'bg-orange-900/20 hover:bg-orange-900/40 border-orange-500/30 text-orange-400'} border rounded font-bold uppercase text-[10px] tracking-widest transition-all active:scale-95`}>
                            {isHp ? 'Dano (-)' : 'Gastar (-)'}
                        </button>
                        <button onClick={() => handleApply('add')} className={`py-3.5 ${isHp ? 'bg-green-900/20 hover:bg-green-900/40 border-green-500/30 text-green-400' : 'bg-blue-900/20 hover:bg-blue-900/40 border-blue-500/30 text-blue-400'} border rounded font-bold uppercase text-[10px] tracking-widest transition-all active:scale-95`}>
                            {isHp ? 'Curar (+)' : 'Recuperar (+)'}
                        </button>
                    </div>
                </div>
            </div>
          );
      };

      const AttributeCard = ({ label, value, icon: Icon, color, isEditing, onRoll, onChange, onLabelChange }) => {
        return (
            <div className="tech-border bg-[#131316] p-3 py-4 flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 transition-all group relative overflow-hidden h-full z-0" onClick={!isEditing ? onRoll : undefined}>
                <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                <div className="relative z-10 flex flex-col items-center w-full">
                    <Icon size={24} style={{ color }} className="mb-3 drop-shadow-[0_0_8px_rgba(0,0,0,0.8)] group-hover:scale-110 transition-transform duration-300"/>
                    
                    {isEditing ? (
                        <input type="number" value={value} onChange={(e) => onChange(parseInt(e.target.value) || 0)} className="w-full bg-black/40 border-b border-white/20 text-center text-white font-mono text-2xl py-1 relative z-20"/>
                    ) : (
                        <span className="text-3xl font-mono font-bold text-white group-hover:text-theme transition-colors drop-shadow-md">{value >= 0 ? `+${value}` : value}</span>
                    )}
                    
                    {isEditing ? (
                         <input value={label} onChange={e => onLabelChange(e.target.value)} className="text-[9px] font-tech uppercase tracking-widest text-gray-500 mt-2 text-center w-full relative z-20"/>
                    ) : (
                        <span className="text-[9px] font-tech uppercase tracking-[0.2em] text-gray-500 mt-2 truncate w-full text-center group-hover:text-gray-300 transition-colors">{label.substring(0, 10)}</span>
                    )}
                </div>
            </div>
        );
      };

      const AttributesRadar = ({ attributes, labels, size = 200, color }) => {
        const keys = ['strength', 'intelligence', 'charisma', 'determination', 'constitution', 'prestidigitation'];
        const displayLabels = labels || { strength: 'FOR', intelligence: 'INT', charisma: 'CAR', determination: 'DET', constitution: 'CON', prestidigitation: 'DES' };
        
        const ATTR_ICONS = { strength: Sword, intelligence: Brain, charisma: Feather, determination: Dna, constitution: Activity, prestidigitation: Ghost };
        const center = size / 2;
        const radius = size * 0.38;
        const maxVal = 10; const minVal = -2; const range = maxVal - minVal;

        const getPoint = (val, i) => {
            const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2;
            const normalized = Math.max(0, (Math.min(maxVal, val) - minVal) / range);
            const r = radius * normalized;
            return [center + Math.cos(angle) * r, center + Math.sin(angle) * r];
        };
        const polyPoints = keys.map((k, i) => getPoint(attributes[k], i).join(',')).join(' ');

        return (
            <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="overflow-visible select-none pointer-events-none">
                <defs><filter id="radar-glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                {/* Background Web */}
                {[0.25, 0.5, 0.75, 1].map((scale, idx) => (
                    <polygon key={idx} points={keys.map((_, i) => {
                        const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2;
                        return `${center + Math.cos(angle) * radius * scale},${center + Math.sin(angle) * radius * scale}`;
                    }).join(' ')} fill="none" stroke="rgba(255,255,255,0.08)" strokeDasharray={idx === 3 ? "0" : "2 2"} />
                ))}
                {/* Axes & Labels */}
                {keys.map((k, i) => {
                     const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2;
                     const lx = center + Math.cos(angle) * (radius + 24);
                     const ly = center + Math.sin(angle) * (radius + 24);
                     const labelText = displayLabels[k].substring(0, 3).toUpperCase();
                     const Icon = ATTR_ICONS[k];
                     return (
                        <g key={i}>
                            <line x1={center} y1={center} x2={center + Math.cos(angle) * radius} y2={center + Math.sin(angle) * radius} stroke="rgba(255,255,255,0.05)" />
                            <foreignObject x={lx - 10} y={ly - 18} width={20} height={20}>
                                <div className="flex items-center justify-center w-full h-full text-gray-500"><Icon size={12} /></div>
                            </foreignObject>
                            <text x={lx} y={ly + 6} textAnchor="middle" dominantBaseline="middle" fill="#666" fontSize="8" className="font-tech font-bold tracking-widest">{labelText}</text>
                        </g>
                     )
                })}
                {/* Data */}
                <polygon points={polyPoints} fill={color} fillOpacity="0.25" stroke={color} strokeWidth="1.5" style={{filter: 'url(#radar-glow)'}} className="transition-all duration-500"/>
                {keys.map((k, i) => {
                    const [x, y] = getPoint(attributes[k], i);
                    return <circle key={i} cx={x} cy={y} r="2" fill="white" className="transition-all duration-500"/>
                })}
            </svg>
        )
      };

      const NenHexagon = ({ activeType, size = 160 }) => {
        const typeOrder = [NenType.Enhancer, NenType.Transmuter, NenType.Conjurer, NenType.Specialist, NenType.Manipulator, NenType.Emitter];
        const points = [{ x: 50, y: 10, l:'Reforço' }, { x: 84.6, y: 30, l:'Trans.' }, { x: 84.6, y: 70, l:'Mat.' }, { x: 50, y: 90, l:'Esp.' }, { x: 15.4, y: 70, l:'Man.' }, { x: 15.4, y: 30, l:'Emis.' }];
        
        const getEfficiencies = (type) => {
            const index = typeOrder.indexOf(type);
            return typeOrder.map((t, i) => {
                if (type === NenType.Specialist) return t === NenType.Specialist ? 1.0 : (t === NenType.Conjurer || t === NenType.Manipulator ? 0.8 : (t === NenType.Enhancer ? 0.4 : 0.6));
                if (t === NenType.Specialist) return 0.0;
                let dist = Math.abs(index - i);
                if (dist > 3) dist = 6 - dist;
                return Math.max(0, 1.0 - (dist * 0.2));
            });
        };
        const efficiencies = getEfficiencies(activeType);
        const activeColor = NEN_COLORS[activeType] || '#fff';
        const polyPoints = points.map((p, i) => {
            const eff = Math.max(0.1, efficiencies[i]);
            return `${50 + (p.x - 50) * eff},${50 + (p.y - 50) * eff}`;
        }).join(' ');

        return (
            <div className="relative flex items-center justify-center pointer-events-none" style={{width: size, height: size}}>
                 <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible drop-shadow-[0_0_15px_rgba(0,0,0,0.6)]">
                    <defs><filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                    {/* Grid */}
                    <polygon points={points.map(p => `${p.x},${p.y}`).join(' ')} fill="none" stroke="rgba(255,255,255,0.08)" strokeWidth="0.5" strokeDasharray="2 2"/>
                    <polygon points={points.map(p => `${50 + (p.x - 50) * 0.6},${50 + (p.y - 50) * 0.6}`).join(' ')} fill="none" stroke="rgba(255,255,255,0.05)" strokeWidth="0.5"/>
                    
                    {points.map((p, i) => (
                        <g key={i}>
                            <text x={p.x} y={p.y < 50 ? p.y - 6 : p.y + 12} textAnchor="middle" fontSize="6" fill={efficiencies[i] === 1 ? activeColor : '#666'} className="font-tech font-bold uppercase tracking-wide">{p.l}</text>
                            <text x={p.x} y={p.y < 50 ? p.y - 13 : p.y + 18} textAnchor="middle" fontSize="4" fill={efficiencies[i] > 0 ? '#888' : '#333'} className="font-mono">{(efficiencies[i]*100).toFixed(0)}%</text>
                        </g>
                    ))}
                    <polygon points={polyPoints} fill={activeColor} fillOpacity="0.15" stroke={activeColor} strokeWidth="1.5" strokeLinejoin="round" style={{ filter: 'url(#glow)' }} className="transition-all duration-700"/>
                    <circle cx="50" cy="50" r="1.5" fill="white" opacity="0.5"/>
                </svg>
            </div>
        );
      }

      // --- MAIN APP ---

      const App = () => {
        const [loadedFromUrl, setLoadedFromUrl] = useState(false);
        const [showShareModal, setShowShareModal] = useState(false);
        const [logs, setLogs] = useState([]);
        const [characters, setCharacters] = useState(() => {
             try {
                const urlParams = new URLSearchParams(window.location.search);
                const sharedData = urlParams.get('data');
                if (sharedData) return JSON.parse(b64_to_utf8(sharedData));
             } catch(e) {}
             try {
                const saved = localStorage.getItem('hxh_chars');
                if (saved) return JSON.parse(saved);
             } catch(e) {}
             return [INITIAL_CHARACTER];
        });

        const [activeCharId, setActiveCharId] = useState(() => characters[0]?.id || 'char_default');
        const [isCharModalOpen, setIsCharModalOpen] = useState(false);
        const [isEditing, setIsEditing] = useState(false);
        const [activeTab, setActiveTab] = useState('hatsus');
        const [uploadTarget, setUploadTarget] = useState(null); 
        const [conditionInput, setConditionInput] = useState("");
        const [calculatorTarget, setCalculatorTarget] = useState(null); 
        
        const fileInputRef = useRef(null);
        const logsEndRef = useRef(null);

        useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('data')) setLoadedFromUrl(true);
        }, []);

        useEffect(() => {
            if (!loadedFromUrl) {
                try { localStorage.setItem('hxh_chars', JSON.stringify(characters)); } catch(e) { console.error("Storage full"); }
            }
        }, [characters, loadedFromUrl]);

        useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

        const addLog = (title, result, detail, type = 'info') => {
            setLogs(prev => [...prev, { id: Math.random(), title, result, detail, type, time: new Date() }]);
        };

        const handleStateUpdate = (newCharsFn) => {
            if (loadedFromUrl) {
                if(confirm("Você está editando uma ficha compartilhada. Isso salvará uma cópia local.")) {
                    setLoadedFromUrl(false);
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else return;
            }
            setCharacters(prev => typeof newCharsFn === 'function' ? newCharsFn(prev) : newCharsFn);
        };

        const updateChar = (field, value) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, [field]: value } : c));
        const updateAttribute = (attr, val) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, attributes: { ...c.attributes, [attr]: val } } : c));
        const updateAttributeLabel = (attr, val) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, attributeLabels: { ...(c.attributeLabels || INITIAL_CHARACTER.attributeLabels), [attr]: val } } : c));
        const updateEquippedWeapon = (field, val) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, equippedWeapon: { ...(c.equippedWeapon || {}), [field]: val } } : c));

        const char = characters.find(c => c.id === activeCharId) || characters[0];
        const themeColor = char ? (NEN_COLORS[char.nenType] || '#9b59b6') : '#9b59b6';
        
        const attrLabels = char.attributeLabels || INITIAL_CHARACTER.attributeLabels;
        const equippedWeapon = char.equippedWeapon || { name: 'Desarmado', damage: '1d4', description: 'Ataques básicos.', powers: '', imageUrl: '' };

        const handleRollAttribute = (attrKey, value) => {
            if(isEditing) return;
            const label = attrLabels[attrKey];
            const d20 = Math.floor(Math.random() * 20) + 1;
            const total = d20 + value;
            addLog(`Teste de ${label}`, total, `[d20: ${d20}] ${value >= 0 ? '+' : ''}${value}`, total >= 20 ? 'crit' : total <= 1 ? 'fail' : 'info');
        };

        const handleRollGeneric = (sides) => {
             const result = Math.floor(Math.random() * sides) + 1;
             addLog(`Rolagem d${sides}`, result, `Dado de ${sides} lados`, result === sides ? 'crit' : result === 1 ? 'fail' : 'info');
        }

        const handleRollWeapon = (weapon) => {
            if(isEditing) return;
            const roll = rollDice(weapon.damage);
            addLog(`Ataque: ${weapon.name}`, roll.total > 0 ? roll.total : '0', roll.str ? `[${roll.str}]: ${roll.rolls.join('+')}` : '', 'combat');
        };

        const handleRollSkill = (skill, sourceName) => {
            if(isEditing) return;
            const roll = rollDice(skill.damage || skill.damageDice);
            addLog(`Uso: ${skill.name} (${sourceName || 'Habilidade'})`, roll.total > 0 ? roll.total : 'Ativado', roll.str ? `[${roll.str}]: ${roll.rolls.join('+')}` : 'Efeito ativado', 'combat');
            
            if(skill.cost > 0) {
                 const costType = skill.costType || 'Nen';
                 if (costType === 'HP') {
                    if(char.currentHp > skill.cost) {
                        updateChar('currentHp', char.currentHp - skill.cost);
                        addLog('Custo Vital', `-${skill.cost} HP`, 'Sacrifício de vida', 'fail');
                    } else {
                        alert("Vida insuficiente!");
                    }
                 } else {
                     if(char.currentNen >= skill.cost) {
                         updateChar('currentNen', char.currentNen - skill.cost);
                     } else {
                         alert("Nen insuficiente!");
                     }
                 }
            }
        };

        const handleOpenCalculator = (type, id, field, label, current, max) => {
             setCalculatorTarget({ type, id, field, label, current, max });
        };

        const handleApplyCalculation = (delta) => {
            if (!calculatorTarget) return;
            const { type, id, field, current, max, label } = calculatorTarget;
            let newValue = current + delta;
            newValue = Math.max(0, Math.min(max, newValue));
            const isGain = delta > 0;
            const logType = field.toLowerCase().includes('hp') ? (isGain ? 'info' : 'fail') : 'info';
            const logLabel = isGain ? (field.includes('Hp') ? 'Curado' : 'Recuperado') : (field.includes('Hp') ? 'Dano' : 'Gasto');
            addLog(`Calculadora: ${label}`, `${newValue}`, `${logLabel}: ${Math.abs(delta)} (Antes: ${current})`, logType);
            if (type === 'char') {
                updateChar(field, newValue);
            } else if (type === 'summon') {
                 const newSummons = char.summons.map(s => s.id === id ? {...s, [field]: newValue} : s);
                 updateChar('summons', newSummons);
            }
        };

        const addCondition = () => {
             if (!conditionInput.trim()) return;
             const newConditions = [...(char.conditions || []), conditionInput.trim()];
             updateChar('conditions', newConditions);
             setConditionInput("");
        }

        const removeCondition = (idx) => {
             const newConditions = (char.conditions || []).filter((_, i) => i !== idx);
             updateChar('conditions', newConditions);
        }

        const addItem = (type, parentId) => {
             if (type === 'skill') {
                const category = activeTab === 'hatsus' ? 'Hatsu' : activeTab === 'combat' ? 'Combat' : 'Weapon';
                const newSkill = { id: Math.random().toString(36), name: 'Nova Habilidade', category, type: 'Ativa', cost: 0, costType: 'Nen', damageDice: '1d6', description: 'Descrição...', imageUrl: '' };
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, skills: [...c.skills, newSkill] } : c));
             }
             if (type === 'item') {
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, inventory: [...c.inventory, {id: Math.random().toString(), name: 'Item', quantity: 1}] } : c));
             }
             if (type === 'summon') {
                 const newSummon = { id: Math.random().toString(36), name: 'Nova Invocação', avatarUrl: '', type: 'Besta de Nen', currentHp: 10, maxHp: 10, currentNen: 5, maxNen: 5, attributes: { strength: 0, constitution: 0, intelligence: 0, charisma: 0, determination: 0, prestidigitation: 0 }, description: 'Descrição...', skills: [] };
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: [...c.summons, newSummon] } : c));
             }
             if (type === 'summonSkill' && parentId) {
                const newSummonSkill = { id: Math.random().toString(36), name: 'Nova Habilidade', cost: 1, costType: 'Nen', damage: '1d4', description: 'Efeito...' };
                const newSummons = char.summons.map(s => s.id === parentId ? { ...s, skills: [...(s.skills || []), newSummonSkill] } : s);
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: newSummons } : c));
             }
        }
        
        const deleteItem = (collection, id, parentId) => {
             if(confirm("Tem certeza que deseja excluir?")) {
                if (collection === 'summonSkill' && parentId) {
                    const newSummons = char.summons.map(s => s.id === parentId ? { ...s, skills: s.skills.filter(k => k.id !== id) } : s);
                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: newSummons } : c));
                } else {
                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, [collection]: c[collection].filter(i => i.id !== id) } : c));
                }
             }
        }

        const copyLink = () => {
            const jsonStr = JSON.stringify(characters);
            const url = `${window.location.origin}${window.location.pathname}?data=${utf8_to_b64(jsonStr)}`;
            navigator.clipboard.writeText(url);
            alert("Link copiado!");
            setShowShareModal(false);
        };

        const triggerUpload = (target) => { 
            setUploadTarget(target);
            fileInputRef.current?.click();
        }

        const handleUpload = async (e) => {
            const file = e.target.files?.[0];
            if(file && uploadTarget) {
                try {
                    const res = await resizeImage(file);
                    if (uploadTarget.type === 'avatar') updateChar('avatarUrl', res);
                    else if (uploadTarget.type === 'skill' && uploadTarget.id) {
                        const newSkills = char.skills.map(s => s.id === uploadTarget.id ? {...s, imageUrl: res} : s);
                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                    } else if (uploadTarget.type === 'summon' && uploadTarget.id) {
                        const newSummons = char.summons.map(s => s.id === uploadTarget.id ? {...s, avatarUrl: res} : s);
                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                    } else if (uploadTarget.type === 'equippedWeapon') updateChar('equippedWeapon', { ...(char.equippedWeapon || {}), imageUrl: res });
                } catch (error) { console.error("Error processing image:", error); } 
                finally { setUploadTarget(null); if (fileInputRef.current) fileInputRef.current.value = ''; }
            }
        }

        if (!char) return <div className="text-white flex items-center justify-center h-screen">Inicializando...</div>;

        return (
            <div className={`min-h-screen font-body pb-12 overflow-x-hidden selection:bg-theme selection:text-white relative bg-hunter-pattern ${isEditing ? 'edit-mode' : ''}`} style={{ '--theme-color': themeColor }}>
                
                <input type="file" ref={fileInputRef} className="hidden" onChange={handleUpload}/>

                {/* Navbar */}
                <div className="sticky top-0 z-50 bg-[#0a0a0c]/80 backdrop-blur-xl border-b border-white/5 px-4 py-3 flex justify-between items-center shadow-2xl">
                    <div className="flex items-center gap-4">
                        <div className="w-10 h-10 flex items-center justify-center bg-white/5 rounded border border-white/10 tech-border hover:border-theme/50 transition-colors relative z-10">
                            <span className="font-title text-theme text-2xl font-bold select-none">H</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="font-tech text-[10px] font-bold tracking-[0.3em] text-gray-500 uppercase">Sistema Hunter</span>
                            <span className="font-bold text-white text-sm tracking-widest uppercase">{char.nickname}</span>
                        </div>
                    </div>
                    <div className="flex gap-3 relative z-10">
                        <button onClick={() => setShowShareModal(true)} className="p-2.5 text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-full transition-all border border-transparent hover:border-white/10"><Share2 size={18}/></button>
                        <button onClick={() => setIsCharModalOpen(true)} className="p-2.5 text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-full transition-all border border-transparent hover:border-white/10"><Users size={18}/></button>
                        <button onClick={() => setIsEditing(!isEditing)} className={`px-5 py-2 rounded text-xs font-bold uppercase tracking-wider border transition-all ${isEditing ? 'bg-white text-black border-white shadow-[0_0_15px_rgba(255,255,255,0.4)]' : 'bg-transparent text-theme border-theme hover:bg-theme hover:text-white'}`}>
                            {isEditing ? 'Salvar' : 'Editar'}
                        </button>
                    </div>
                </div>

                {/* Main Grid */}
                <div className="relative z-10 max-w-7xl mx-auto p-4 md:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left Column: Avatar & Vitals */}
                    <div className="lg:col-span-4 flex flex-col gap-6">
                        
                        {/* Avatar Card (Hunter License Style) */}
                        <div className="relative bg-[#0a0a0c] avatar-frame shadow-2xl tech-border group overflow-hidden">
                             {/* Background Texture */}
                            <div className="absolute inset-0 license-pattern opacity-10 pointer-events-none"></div>
                            
                            <div className="h-96 w-full relative bg-gray-900 overflow-hidden">
                                <img src={char.avatarUrl} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-all duration-700 scale-100 group-hover:scale-105"/>
                                <div className="absolute inset-0 bg-gradient-to-t from-[#0a0a0c] via-transparent to-transparent pointer-events-none"></div>
                                
                                {isEditing && <button onClick={() => triggerUpload({type:'avatar'})} className="absolute top-4 right-4 p-3 bg-black/50 backdrop-blur text-white rounded hover:bg-white hover:text-black border border-white/20 z-20"><Upload size={20}/></button>}
                                
                                <div className="absolute bottom-4 left-6 right-6 z-20">
                                    {isEditing ? <input value={char.nickname} onChange={e => updateChar('nickname', e.target.value)} className="bg-black/50 backdrop-blur border-b border-white/50 text-4xl font-title text-white w-full px-2 py-1"/> : 
                                    <h1 className="text-4xl lg:text-5xl font-title text-white drop-shadow-lg leading-tight tracking-wide" style={{textShadow: `0 0 15px ${themeColor}80`}}>{char.nickname}</h1>}
                                    <div className="flex items-center gap-2 mt-2">
                                        <div className="h-[1px] bg-theme w-8"></div>
                                        <span className="text-xs font-tech text-theme uppercase tracking-[0.2em]">{char.nenType}</span>
                                    </div>
                                </div>
                            </div>

                            {/* XP Strip */}
                            <div className="bg-[#101012] px-6 py-4 border-t border-white/5 flex justify-between items-center font-mono text-xs relative z-10">
                                <div className="flex items-center gap-3">
                                    <span className="text-gray-500 font-tech tracking-widest text-[10px]">NÍVEL</span>
                                    {isEditing ? (
                                        <input type="number" value={char.hunterLevel} onChange={(e) => updateChar('hunterLevel', parseInt(e.target.value) || 0)} className="w-12 text-center text-white bg-white/5 border-b border-white/20"/>
                                    ) : (
                                        <span className="text-white text-lg font-bold">{char.hunterLevel}</span>
                                    )}
                                </div>
                                <div className="flex-1 ml-6 text-right">
                                    {isEditing ? (
                                        <div className="flex justify-end gap-1 items-center mb-1">
                                            <input type="number" value={char.xp} onChange={(e) => updateChar('xp', parseInt(e.target.value) || 0)} className="w-16 text-right text-white"/>
                                            <span className="text-gray-600">/</span>
                                            <input type="number" value={char.maxXp} onChange={(e) => updateChar('maxXp', parseInt(e.target.value) || 0)} className="w-16 text-center text-gray-400"/>
                                        </div>
                                    ) : (
                                        <span className="text-gray-500 text-[10px] tracking-wider mb-1 block">{char.xp} / {char.maxXp} XP</span>
                                    )}
                                    <div className="w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                                        <div className="h-full bg-theme shadow-[0_0_10px_var(--theme-color)]" style={{width: `${Math.min(100, (char.xp/char.maxXp)*100)}%`}}></div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Personal Details */}
                            <div className="p-6 grid grid-cols-2 gap-y-4 gap-x-4 text-sm font-mono bg-[#0d0d10] border-t border-white/5 relative z-10">
                                {[{l:'Idade',k:'age'},{l:'Altura',k:'height'},{l:'Peso',k:'weight'},{l:'Origem',k:'nationality'}].map(f => (
                                    <div key={f.k}>
                                        <span className="text-gray-600 block text-[9px] uppercase tracking-widest mb-1">{f.l}</span>
                                        {isEditing ? <input value={char[f.k]} onChange={e => updateChar(f.k, e.target.value)} className="w-full text-gray-200"/> : <span className="text-gray-300 font-bold">{char[f.k]}</span>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Nen Analysis Card */}
                        <div className="glass-panel p-6 tech-border flex flex-col items-center relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none"><Hexagon size={120} /></div>
                            <div className="flex justify-between w-full items-center mb-4 relative z-10">
                                <span className="text-xs font-tech uppercase tracking-[0.2em] text-gray-500 flex items-center gap-2"><Activity size={14}/> Afinidade de Nen</span>
                                {isEditing && <select value={char.nenType} onChange={e => updateChar('nenType', e.target.value)} className="bg-black/50 border border-white/20 text-white text-[10px] p-1 uppercase rounded z-20 relative">{Object.keys(NenType).map(k => <option key={k} value={NenType[k]}>{NenType[k]}</option>)}</select>}
                            </div>
                            <NenHexagon activeType={char.nenType} size={240} />
                            <div className="mt-4 text-center">
                                <span className="text-2xl font-title text-white drop-shadow-md" style={{color: themeColor}}>{char.nenType.split(' ')[0]}</span>
                            </div>
                        </div>
                    </div>

                    {/* Right Column: Stats & Tabs */}
                    <div className="lg:col-span-8 flex flex-col gap-6">
                        {/* Vitals & Attributes */}
                        <div className="grid grid-cols-1 md:grid-cols-[1fr_1.5fr] gap-6">
                            
                            {/* Stats & Conditions */}
                            <div className="flex flex-col gap-6">
                                <div className="glass-panel p-6 tech-border flex flex-col justify-center gap-6">
                                    <StatBar label="Vitalidade (HP)" current={char.currentHp} max={char.maxHp} color="#ef4444" icon={<Heart size={14}/>} isEditing={isEditing} 
                                        onChange={v => updateChar('currentHp', v)} 
                                        onMaxChange={v => updateChar('maxHp', v)}
                                        onOpenCalculator={() => handleOpenCalculator('char', char.id, 'currentHp', 'Vitalidade', char.currentHp, char.maxHp)}
                                    />
                                    <StatBar label="Aura (Nen)" current={char.currentNen} max={char.maxNen} color={themeColor} icon={<Zap size={14}/>} isEditing={isEditing} 
                                        onChange={v => updateChar('currentNen', v)} 
                                        onMaxChange={v => updateChar('maxNen', v)} 
                                        onOpenCalculator={() => handleOpenCalculator('char', char.id, 'currentNen', 'Aura', char.currentNen, char.maxNen)}
                                    />
                                    
                                    <div className="mt-2 flex items-center justify-between bg-black/40 p-4 rounded border border-white/5 relative overflow-hidden group">
                                        <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-10 transition-opacity pointer-events-none"></div>
                                        <div className="flex items-center gap-3 relative z-10">
                                            <Shield size={20} className="text-gray-500"/>
                                            <span className="text-xs font-tech text-gray-400 uppercase tracking-widest">Classe de Armadura</span>
                                        </div>
                                        {isEditing ? <input type="number" value={char.ca} onChange={e => updateChar('ca', parseInt(e.target.value))} className="w-16 bg-transparent text-white text-center font-bold text-3xl border-b border-white/20 relative z-20"/> : <span className="text-3xl font-bold text-white font-mono relative z-20">{char.ca}</span>}
                                    </div>

                                    {/* Conditions */}
                                    <div className="bg-black/40 p-4 rounded border border-white/5 relative min-h-[80px]">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-[10px] font-tech text-gray-500 uppercase tracking-widest flex items-center gap-2"><AlertCircle size={12}/> Status Atuais</span>
                                            {isEditing && (
                                                <div className="flex items-center gap-1 relative z-20">
                                                    <input value={conditionInput} onChange={e => setConditionInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addCondition()} placeholder="Add..." className="bg-black/50 border border-white/10 text-[10px] text-white px-2 py-1 w-20 outline-none rounded"/>
                                                    <button onClick={addCondition} className="bg-theme text-[10px] text-white px-2 py-1 rounded hover:bg-white hover:text-black transition-colors font-bold">+</button>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-wrap gap-2 relative z-10">
                                            {(!char.conditions || char.conditions.length === 0) && <span className="text-[10px] text-gray-700 italic py-1">Personagem em estado normal.</span>}
                                            {(char.conditions || []).map((cond, idx) => (
                                                <span key={idx} className="text-[10px] font-bold px-3 py-1 bg-red-500/10 text-red-200 border border-red-500/20 rounded-full flex items-center gap-2 hover:bg-red-500/20 transition-colors cursor-default">
                                                    {cond}
                                                    {isEditing && <button onClick={() => removeCondition(idx)} className="hover:text-white"><X size={10}/></button>}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="glass-panel p-4 tech-border flex items-center justify-center">
                                    <AttributesRadar attributes={char.attributes} labels={attrLabels} size={200} color={themeColor} />
                                </div>
                            </div>
                            
                            {/* Attributes Grid */}
                            <div className="glass-panel p-4 tech-border">
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 h-full content-start">
                                    <AttributeCard label={attrLabels.strength} value={char.attributes.strength} icon={Sword} color="#c0392b" isEditing={isEditing} onRoll={() => handleRollAttribute('strength', char.attributes.strength)} onChange={(v) => updateAttribute('strength', v)} onLabelChange={(v) => updateAttributeLabel('strength', v)} />
                                    <AttributeCard label={attrLabels.intelligence} value={char.attributes.intelligence} icon={Brain} color="#8e44ad" isEditing={isEditing} onRoll={() => handleRollAttribute('intelligence', char.attributes.intelligence)} onChange={(v) => updateAttribute('intelligence', v)} onLabelChange={(v) => updateAttributeLabel('intelligence', v)} />
                                    <AttributeCard label={attrLabels.charisma} value={char.attributes.charisma} icon={Feather} color="#27ae60" isEditing={isEditing} onRoll={() => handleRollAttribute('charisma', char.attributes.charisma)} onChange={(v) => updateAttribute('charisma', v)} onLabelChange={(v) => updateAttributeLabel('charisma', v)} />
                                    <AttributeCard label={attrLabels.determination} value={char.attributes.determination} icon={Dna} color="#f1c40f" isEditing={isEditing} onRoll={() => handleRollAttribute('determination', char.attributes.determination)} onChange={(v) => updateAttribute('determination', v)} onLabelChange={(v) => updateAttributeLabel('determination', v)} />
                                    <AttributeCard label={attrLabels.constitution} value={char.attributes.constitution} icon={Activity} color="#2980b9" isEditing={isEditing} onRoll={() => handleRollAttribute('constitution', char.attributes.constitution)} onChange={(v) => updateAttribute('constitution', v)} onLabelChange={(v) => updateAttributeLabel('constitution', v)} />
                                    <AttributeCard label={attrLabels.prestidigitation} value={char.attributes.prestidigitation} icon={Ghost} color="#e67e22" isEditing={isEditing} onRoll={() => handleRollAttribute('prestidigitation', char.attributes.prestidigitation)} onChange={(v) => updateAttribute('prestidigitation', v)} onLabelChange={(v) => updateAttributeLabel('prestidigitation', v)} />
                                </div>
                            </div>
                        </div>

                        {/* Tabs & Content */}
                        <div className="glass-panel tech-border flex flex-col h-[calc(100vh-8rem)] relative overflow-hidden">
                            {/* Tab Headers */}
                            <div className="flex bg-black/40 border-b border-white/5 overflow-x-auto no-scrollbar scroll-smooth relative z-20 flex-shrink-0">
                                {[
                                    {id: 'hatsus', label: 'Hatsus', icon: Zap},
                                    {id: 'combat', label: 'Combate', icon: Target},
                                    {id: 'weapon', label: 'Armas', icon: Sword},
                                    {id: 'summons', label: 'Invocações', icon: PawPrint},
                                    {id: 'inventory', label: 'Inventário', icon: Box},
                                    {id: 'bio', label: 'Bio', icon: ScrollText}
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-4 text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all border-b-2 whitespace-nowrap outline-none ${activeTab === tab.id ? 'text-white border-theme bg-white/5' : 'text-gray-500 border-transparent hover:text-gray-300 hover:bg-white/5'}`}>
                                        <tab.icon size={16} className={activeTab === tab.id ? 'text-theme' : ''} /> {tab.label}
                                    </button>
                                ))}
                            </div>

                            {/* Tab Body */}
                            <div className="p-6 md:p-8 flex-1 bg-gradient-to-b from-transparent to-black/30 overflow-y-auto pb-64 custom-scrollbar relative z-10 pr-2">
                                {/* Skills Logic */}
                                {['hatsus', 'combat', 'weapon'].includes(activeTab) && (
                                    <div className="space-y-6">
                                        
                                        {/* Weapon Card (Specific to Weapon Tab) */}
                                        {activeTab === 'weapon' && (
                                            <div className="mb-8 tech-border bg-[#131316] p-6 relative group rounded-sm">
                                                 <div className="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                                                    <h3 className="text-xs font-tech uppercase tracking-widest text-theme flex items-center gap-2"><Sword size={16}/> Arma Equipada</h3>
                                                    {!isEditing && equippedWeapon.damage && <span className="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded">Dano Base: {equippedWeapon.damage}</span>}
                                                 </div>
                                                 
                                                 <div className="flex flex-col md:flex-row gap-6">
                                                    {/* Weapon Image */}
                                                    <div className="w-full md:w-48 h-48 bg-black/40 relative border border-white/10 flex-shrink-0 group-hover:border-white/20 transition-colors">
                                                        {equippedWeapon.imageUrl ? <img src={equippedWeapon.imageUrl} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-white/10"><Sword size={48}/></div>}
                                                         {isEditing && (
                                                            <button onClick={() => triggerUpload({type: 'equippedWeapon'})} className="absolute inset-0 bg-black/70 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity backdrop-blur-sm z-20">
                                                                <Camera size={24}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                    {/* Weapon Details */}
                                                    <div className="flex-1 flex flex-col">
                                                        <div className="flex justify-between items-start mb-3">
                                                             <div className="flex-1">
                                                                 {isEditing ? <input className="w-full bg-transparent border-b border-white/20 text-2xl font-title text-white mb-2" value={equippedWeapon.name} onChange={e => updateEquippedWeapon('name', e.target.value)} placeholder="Nome da Arma"/> : <h2 className="text-2xl font-title text-white mb-2">{equippedWeapon.name}</h2>}
                                                             </div>
                                                             {/* Damage Roll Button */}
                                                             {!isEditing && equippedWeapon.damage && (
                                                                <button onClick={() => handleRollWeapon(equippedWeapon)} className="ml-4 text-xs font-mono text-red-300 bg-red-500/10 px-3 py-2 border border-red-500/20 hover:bg-red-500/20 hover:border-red-500/40 flex items-center gap-2 cursor-pointer transition-all rounded shadow-lg shadow-red-900/10 z-20 relative">
                                                                    <Dice5 size={14}/> Rolar Dano
                                                                </button>
                                                             )}
                                                             {isEditing && <input className="bg-red-900/20 border border-red-500/20 text-sm text-red-300 w-24 px-2 py-1 text-center rounded ml-4" placeholder="Dano" value={equippedWeapon.damage} onChange={e => updateEquippedWeapon('damage', e.target.value)} />}
                                                        </div>
                                                        
                                                        <div className="grid gap-4 mt-auto">
                                                            {/* Description */}
                                                            <div className="bg-black/20 p-3 rounded border border-white/5">
                                                                <span className="text-[10px] font-bold text-gray-500 uppercase block mb-1 tracking-wider">Aparência e História</span>
                                                                {isEditing ? <textarea className="w-full bg-transparent text-gray-300 resize-none h-16 text-sm" value={equippedWeapon.description} onChange={e => updateEquippedWeapon('description', e.target.value)} placeholder="Descrição visual da arma..."/> : <p className="text-sm text-gray-300 leading-relaxed">{equippedWeapon.description}</p>}
                                                            </div>
                                                            {/* Powers */}
                                                            <div className="bg-blue-900/10 p-3 rounded border border-blue-500/10">
                                                                <span className="text-[10px] font-bold text-blue-400/70 uppercase flex items-center gap-1 mb-1 tracking-wider"><Sparkles size={12}/> Habilidades Especiais</span>
                                                                {isEditing ? <textarea className="w-full bg-transparent text-blue-200 resize-none h-16 text-sm" value={equippedWeapon.powers} onChange={e => updateEquippedWeapon('powers', e.target.value)} placeholder="Efeitos passivos..."/> : <p className="text-sm text-blue-200 whitespace-pre-wrap leading-relaxed">{equippedWeapon.powers || <span className="text-gray-600 italic">Nenhum poder especial.</span>}</p>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                 </div>
                                            </div>
                                        )}

                                        {activeTab === 'weapon' && <div className="flex items-center gap-4 py-4"><div className="h-[1px] bg-white/10 flex-1"></div><span className="text-xs font-bold uppercase text-gray-600 tracking-widest">Técnicas</span><div className="h-[1px] bg-white/10 flex-1"></div></div>}

                                        {char.skills.filter(s => s.category.toLowerCase() === (activeTab === 'hatsus' ? 'hatsu' : activeTab)).length === 0 && <div className="text-gray-600 italic p-10 text-center border-2 border-dashed border-white/5 rounded-lg flex flex-col items-center gap-2"><Info size={24} className="opacity-50"/> Nenhuma habilidade registrada nesta categoria.</div>}
                                        
                                        {char.skills.filter(s => s.category.toLowerCase() === (activeTab === 'hatsus' ? 'hatsu' : activeTab)).map(skill => (
                                            <div key={skill.id} className="tech-border bg-[#131316] group hover:bg-[#18181c] transition-all relative overflow-hidden flex flex-col md:flex-row rounded-sm">
                                                
                                                {/* Skill Image Section */}
                                                <div className="w-full md:w-48 h-48 bg-black/40 relative flex-shrink-0 border-r border-white/5 group-hover:border-white/10 transition-colors">
                                                    {skill.imageUrl ? 
                                                        <img src={skill.imageUrl} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"/> 
                                                        : <div className="w-full h-full flex items-center justify-center text-white/5"><Hexagon size={60}/></div>
                                                    }
                                                    {isEditing && (
                                                        <button onClick={() => triggerUpload({type: 'skill', id: skill.id})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity backdrop-blur-sm z-20">
                                                            <ImageIcon size={24}/>
                                                        </button>
                                                    )}
                                                </div>

                                                <div className="p-5 flex-1 flex flex-col relative z-10">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            {isEditing ? (
                                                                <input className="bg-transparent border-b border-white/20 text-xl font-title text-white w-full mb-1" value={skill.name} onChange={e => {
                                                                    const newSkills = char.skills.map(s => s.id === skill.id ? {...s, name: e.target.value} : s);
                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                }} placeholder="Nome da Habilidade"/>
                                                            ) : (
                                                                <h4 className="font-title text-xl text-white group-hover:text-theme transition-colors cursor-pointer inline-flex items-center gap-2" onClick={() => handleRollSkill(skill)}>{skill.name} <ChevronRight size={14} className="opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 transition-all text-theme"/></h4>
                                                            )}
                                                            
                                                            <div className="flex gap-2 items-center mt-3 flex-wrap">
                                                                {isEditing ? (
                                                                    <>
                                                                        <input type="text" placeholder="Tipo (ex: Ativa)" value={skill.type} onChange={e => {
                                                                            const newSkills = char.skills.map(s => s.id === skill.id ? {...s, type: e.target.value} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                        }} className="bg-white/5 border border-white/10 text-xs text-white px-2 py-1 rounded"/>
                                                                        
                                                                        <div className="flex items-center bg-white/5 border border-white/10 px-2 py-1 rounded">
                                                                            <input type="number" placeholder="Cost" value={skill.cost} onChange={e => {
                                                                                const newSkills = char.skills.map(s => s.id === skill.id ? {...s, cost: parseInt(e.target.value)} : s);
                                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                            }} className="bg-transparent text-xs text-white w-8 text-center outline-none"/>
                                                                            <select value={skill.costType || 'Nen'} onChange={e => {
                                                                                const newSkills = char.skills.map(s => s.id === skill.id ? {...s, costType: e.target.value} : s);
                                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                            }} className="bg-transparent text-xs text-gray-400 outline-none uppercase font-bold">
                                                                                <option value="Nen">Nen</option>
                                                                                <option value="HP">HP</option>
                                                                            </select>
                                                                        </div>

                                                                        <input type="text" placeholder="Dano (ex: 1d6)" value={skill.damageDice} onChange={e => {
                                                                            const newSkills = char.skills.map(s => s.id === skill.id ? {...s, damageDice: e.target.value} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                        }} className="bg-red-500/10 border border-red-500/20 text-xs text-red-300 px-2 py-1 text-center rounded"/>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <span className="text-[10px] uppercase font-bold text-gray-500 bg-white/5 border border-white/5 px-2 py-1 rounded tracking-wide">{skill.type}</span>
                                                                        {skill.cost > 0 && (
                                                                            <span className={`text-[10px] font-mono flex items-center gap-1 px-2 py-1 border rounded ${skill.costType === 'HP' ? 'text-red-300 bg-red-900/20 border-red-500/20' : 'text-blue-300 bg-blue-900/20 border-blue-500/20'}`}>
                                                                                {skill.costType === 'HP' ? <Heart size={10}/> : <Zap size={10}/>} <span className="font-bold">{skill.cost}</span> {skill.costType === 'HP' ? 'HP' : 'AP'}
                                                                            </span>
                                                                        )}
                                                                        {skill.damageDice && <button onClick={() => handleRollSkill(skill)} className="text-[10px] font-mono text-red-300 bg-red-500/10 px-2 py-1 border border-red-500/20 hover:bg-red-500/20 flex items-center gap-1 cursor-pointer transition-colors rounded font-bold z-20 relative"><Dice5 size={12}/> {skill.damageDice}</button>}
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                        {isEditing && <button onClick={() => deleteItem('skills', skill.id)} className="text-red-500 hover:text-white p-2 bg-black/50 rounded transition-colors z-20 relative"><Trash2 size={16}/></button>}
                                                    </div>
                                                    
                                                    <div className="mt-4 flex-1">
                                                        {isEditing ? <textarea value={skill.description} onChange={e => {
                                                            const newSkills = char.skills.map(s => s.id === skill.id ? {...s, description: e.target.value} : s);
                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                        }} className="w-full bg-black/20 text-gray-300 p-3 h-20 resize-none border border-white/5 rounded text-sm"/> : 
                                                        <p className="text-sm text-gray-400 font-serif leading-relaxed pl-3 border-l-2 border-white/10">{skill.description}</p>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('skill')} className="w-full py-6 border border-dashed border-white/10 text-sm font-bold uppercase tracking-widest text-gray-500 hover:text-white hover:border-white transition-all hover:bg-white/5 rounded">+ Adicionar Técnica</button>}
                                    </div>
                                )}

                                {/* Inventory */}
                                {activeTab === 'inventory' && (
                                    <div className="grid grid-cols-1 gap-1">
                                        <div className="flex justify-between items-center px-4 py-2 text-[10px] font-bold uppercase text-gray-500 tracking-widest border-b border-white/10 mb-2">
                                            <span>Item</span>
                                            <span>Qtd</span>
                                        </div>
                                        {char.inventory.map(item => (
                                            <div key={item.id} className="flex justify-between items-center p-4 bg-[#131316] border-l-2 border-transparent hover:border-theme transition-all group relative z-10">
                                                <div className="flex items-center gap-4 flex-1">
                                                    <div className="p-2 bg-black/30 rounded text-gray-500 group-hover:text-white transition-colors"><Box size={18}/></div>
                                                    {isEditing ? <input value={item.name} onChange={e => {
                                                        const newInv = char.inventory.map(i => i.id === item.id ? {...i, name: e.target.value} : i);
                                                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, inventory: newInv} : c));
                                                    }} className="bg-transparent text-white border-b border-white/20 outline-none w-full text-sm"/> : <span className="font-mono text-sm text-gray-300 group-hover:text-white transition-colors">{item.name}</span>}
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    {isEditing ? <input type="number" value={item.quantity} onChange={e => {
                                                        const newInv = char.inventory.map(i => i.id === item.id ? {...i, quantity: parseInt(e.target.value)} : i);
                                                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, inventory: newInv} : c));
                                                    }} className="w-12 bg-white/5 text-center text-white text-sm py-1 rounded"/> : <span className="font-mono text-xs text-theme bg-theme/10 border border-theme/20 px-3 py-1 rounded">x{item.quantity}</span>}
                                                    {isEditing && <button onClick={() => deleteItem('inventory', item.id)} className="text-gray-600 hover:text-red-400 p-1 z-20 relative"><Trash2 size={16}/></button>}
                                                </div>
                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('item')} className="w-full py-4 border border-dashed border-white/10 text-sm font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors mt-4">+ Adicionar Item</button>}
                                    </div>
                                )}

                                {/* Summons */}
                                {activeTab === 'summons' && (
                                    <div className="grid grid-cols-1 gap-10">
                                        
                                        {isEditing && (
                                            <button 
                                                onClick={() => addItem('summon')} 
                                                className="w-full py-5 mb-4 border border-dashed border-theme/50 text-theme bg-theme/5 hover:bg-theme/10 rounded font-bold uppercase tracking-widest flex items-center justify-center gap-3 transition-all text-sm group"
                                            >
                                                <Plus size={18} className="group-hover:scale-110 transition-transform"/> Criar Nova Besta de Nen
                                            </button>
                                        )}

                                        {char.summons.map(summon => (
                                            <div key={summon.id} className="tech-border bg-black/20 overflow-hidden group rounded-sm shadow-xl relative z-10">
                                                {/* Header / Avatar Row */}
                                                <div className="flex flex-col md:flex-row border-b border-white/5">
                                                    <div className="w-full md:w-56 h-56 bg-black/40 relative flex-shrink-0 border-r border-white/10">
                                                        {summon.avatarUrl ? <img src={summon.avatarUrl} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"/> : <div className="w-full h-full flex items-center justify-center text-white/10"><PawPrint size={64}/></div>}
                                                        {isEditing && (
                                                            <button onClick={() => triggerUpload({type: 'summon', id: summon.id})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity backdrop-blur-sm z-20">
                                                                <ImageIcon size={28}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="p-6 flex-1 flex flex-col justify-center">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="flex-1">
                                                                {isEditing ? <input value={summon.name} onChange={e => {
                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, name: e.target.value} : s);
                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                }} className="bg-transparent border-b border-white/20 text-3xl font-title text-white w-full"/> : <h4 className="font-bold text-white text-3xl font-title tracking-wide">{summon.name}</h4>}
                                                                
                                                                {isEditing ? <input value={summon.type} onChange={e => {
                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, type: e.target.value} : s);
                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                }} className="bg-black/30 border border-white/10 text-xs text-gray-400 w-full mt-2 p-1 uppercase"/> : <span className="text-xs uppercase font-bold text-gray-500 mt-2 block tracking-[0.2em]">{summon.type}</span>}
                                                            </div>
                                                            {isEditing && <button onClick={() => deleteItem('summons', summon.id)} className="text-red-500 hover:text-white p-2 bg-white/5 rounded z-20 relative"><Trash2 size={20}/></button>}
                                                        </div>
                                                        
                                                        {isEditing ? <textarea value={summon.description} onChange={e => {
                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, description: e.target.value} : s);
                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                        }} className="w-full h-24 bg-black/30 text-xs text-gray-400 p-3 border border-white/10 resize-none rounded"/> : <p className="text-sm text-gray-400 italic leading-relaxed border-l-2 border-white/10 pl-4">{summon.description}</p>}
                                                    </div>
                                                </div>
                                                
                                                {/* Stats & Radar Row */}
                                                <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 bg-black/40 border-b border-white/5">
                                                    <div className="flex flex-col justify-center gap-2">
                                                        <StatBar label="HP" current={summon.currentHp} max={summon.maxHp} color="#ef4444" icon={<Heart size={12}/>} isEditing={isEditing}
                                                            onChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, currentHp: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                            onMaxChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, maxHp: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                            onOpenCalculator={() => handleOpenCalculator('summon', summon.id, 'currentHp', `HP (${summon.name})`, summon.currentHp, summon.maxHp)}
                                                        />
                                                        <StatBar label="Nen" current={summon.currentNen} max={summon.maxNen} color={themeColor} icon={<Zap size={12}/>} isEditing={isEditing}
                                                             onChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, currentNen: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                            onMaxChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, maxNen: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                            onOpenCalculator={() => handleOpenCalculator('summon', summon.id, 'currentNen', `Nen (${summon.name})`, summon.currentNen, summon.maxNen)}
                                                        />
                                                    </div>
                                                    <div className="flex items-center justify-center relative py-4">
                                                        <div className="scale-100 origin-center">
                                                            <AttributesRadar attributes={summon.attributes} size={160} color={themeColor} />
                                                        </div>
                                                        {isEditing && (
                                                            <div className="absolute inset-0 bg-black/90 flex flex-wrap content-center justify-center gap-2 p-4 z-20 rounded">
                                                                {Object.entries(summon.attributes).map(([key, val]) => (
                                                                    <div key={key} className="flex flex-col items-center bg-white/10 p-2 rounded w-16">
                                                                        <span className="text-[9px] uppercase mb-1 text-gray-400 font-bold">{key.substring(0,3)}</span>
                                                                        <input type="number" value={val} onChange={e => {
                                                                            const newAttrs = {...summon.attributes, [key]: parseInt(e.target.value) || 0};
                                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, attributes: newAttrs} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                        }} className="w-full bg-transparent text-center text-white text-sm font-bold"/>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Summon Skills Section */}
                                                <div className="p-6 bg-[#0f0f11]">
                                                    <div className="text-xs font-bold uppercase tracking-widest text-gray-500 mb-4 border-b border-white/10 pb-2 flex justify-between items-center">
                                                        <span>Habilidades da Invocação</span>
                                                        {isEditing && <button onClick={() => addItem('summonSkill', summon.id)} className="text-theme hover:text-white flex items-center gap-1 text-[10px] bg-theme/10 px-2 py-1 rounded transition-colors z-20 relative"><Plus size={12}/> Add</button>}
                                                    </div>
                                                    <div className="space-y-4">
                                                        {(!summon.skills || summon.skills.length === 0) && <div className="text-xs text-gray-600 italic text-center py-4">Sem habilidades registradas.</div>}
                                                        {(summon.skills || []).map(skill => (
                                                            <div key={skill.id} className="bg-black/40 border border-white/5 p-4 rounded-sm flex flex-col gap-3 relative z-10">
                                                                <div className="flex justify-between items-center">
                                                                    <div className="flex items-center gap-3 flex-1">
                                                                        {isEditing ? <input value={skill.name} onChange={e => {
                                                                            const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, name: e.target.value} : s);
                                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                        }} className="bg-transparent border-b border-white/20 text-sm font-bold text-white w-full"/> : <span className="text-sm font-bold text-white cursor-pointer hover:text-theme transition-colors" onClick={() => handleRollSkill(skill, summon.name)}>{skill.name}</span>}
                                                                    </div>
                                                                    <div className="flex items-center gap-3">
                                                                        {isEditing ? (
                                                                             <div className="flex items-center gap-2">
                                                                                <input type="number" value={skill.cost} onChange={e => {
                                                                                    const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, cost: parseInt(e.target.value)} : s);
                                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                                }} className="w-10 text-xs bg-white/10 text-center p-1 rounded"/>
                                                                                 <select value={skill.costType || 'Nen'} onChange={e => {
                                                                                    const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, costType: e.target.value} : s);
                                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                                }} className="text-xs bg-black text-gray-400 p-1 rounded uppercase">
                                                                                    <option value="Nen">AP</option>
                                                                                    <option value="HP">HP</option>
                                                                                </select>
                                                                             </div>
                                                                        ) : (
                                                                            skill.cost > 0 && <span className={`text-[10px] font-mono px-2 py-0.5 rounded ${skill.costType === 'HP' ? 'text-red-400 bg-red-900/20' : 'text-blue-400 bg-blue-900/20'}`}>{skill.cost} {skill.costType === 'HP' ? 'HP' : 'AP'}</span>
                                                                        )}
                                                                        
                                                                        {isEditing ? <input value={skill.damage} onChange={e => {
                                                                            const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, damage: e.target.value} : s);
                                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                        }} className="w-16 text-xs bg-red-900/30 text-red-200 text-center p-1 rounded" placeholder="Dano"/> : 
                                                                        (skill.damage && <button onClick={() => handleRollSkill(skill, summon.name)} className="text-[10px] text-red-300 flex items-center gap-1 bg-red-500/10 hover:bg-red-500/20 px-2 py-1 rounded transition-colors relative z-20"><Dice5 size={12}/> {skill.damage}</button>)}

                                                                        {isEditing && <button onClick={() => deleteItem('summonSkill', skill.id, summon.id)} className="text-gray-600 hover:text-red-500 p-1 z-20 relative"><Trash2 size={16}/></button>}
                                                                    </div>
                                                                </div>
                                                                <div className="text-xs text-gray-400 border-l-2 border-white/10 pl-3">
                                                                     {isEditing ? <textarea value={skill.description} onChange={e => {
                                                                        const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, description: e.target.value} : s);
                                                                        const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                    }} className="w-full bg-transparent text-gray-400 resize-none h-12"/> : skill.description}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* Bio */}
                                {activeTab === 'bio' && (
                                    isEditing ? <textarea className="w-full h-96 bg-black/20 border border-white/10 p-6 text-gray-300 font-serif leading-loose outline-none resize-none text-base rounded" value={char.bio} onChange={e => updateChar('bio', e.target.value)} /> :
                                    <div className="glass-panel p-8 text-gray-300 font-serif text-lg leading-loose whitespace-pre-wrap shadow-inner bg-black/40">
                                        <span className="text-6xl float-left mr-4 mt-[-10px] font-title text-theme opacity-50">{char.bio.charAt(0)}</span>
                                        {char.bio.substring(1)}
                                    </div>
                                )}
                            </div>

                             {/* Console Log Overlay (Bottom of Tab) */}
                             <div className="absolute bottom-0 left-0 right-0 max-h-56 overflow-y-auto bg-[#08080a]/95 backdrop-blur-md border-t border-white/10 p-4 font-mono text-xs pointer-events-auto shadow-[0_-10px_40px_rgba(0,0,0,0.8)] z-20">
                                <div className="flex flex-wrap items-center justify-between mb-3 sticky top-0 w-full z-10 gap-3 pb-2 border-b border-white/5">
                                    <span className="flex items-center gap-2 text-theme font-bold uppercase tracking-wider text-[10px] animate-pulse-slow"><Terminal size={14}/> Console de Batalha</span>
                                    
                                    <div className="flex gap-4 items-center">
                                        {/* Generic Dice Roller */}
                                        <div className="flex items-center gap-1 bg-white/5 rounded px-2 py-1">
                                            {[4,6,8,10,12,20,100].map(d => (
                                                <button key={d} onClick={() => handleRollGeneric(d)} className="text-[10px] text-gray-400 hover:text-white hover:bg-white/10 px-1.5 py-0.5 rounded transition-colors active:scale-90 font-bold z-20 relative">d{d}</button>
                                            ))}
                                        </div>

                                        <button onClick={() => {
                                            const healHp = Math.floor(char.maxHp * 0.2);
                                            const healNen = Math.floor(char.maxNen * 0.2);
                                            updateChar('currentHp', Math.min(char.maxHp, char.currentHp + healHp));
                                            updateChar('currentNen', Math.min(char.maxNen, char.currentNen + healNen));
                                            addLog('Descanso', 'Recuperado', `+${healHp} HP, +${healNen} AP (20%)`);
                                        }} className="text-[10px] text-green-400 hover:text-white hover:bg-green-600 flex items-center gap-1 bg-green-900/20 px-3 py-1.5 rounded border border-green-500/20 font-bold uppercase tracking-wider transition-all z-20 relative"><BatteryCharging size={12}/> Descansar</button>
                                    </div>
                                </div>
                                
                                <div className="space-y-1 pl-1">
                                    {logs.length === 0 && <div className="text-gray-600 italic py-4 text-center">O log de batalha está vazio.</div>}
                                    {logs.slice().reverse().map(log => (
                                        <div key={log.id} className="flex gap-3 animate-fade-in border-l-2 border-transparent hover:border-theme transition-colors py-1 hover:bg-white/5 px-2 rounded-r">
                                            <span className="text-gray-600 text-[10px] self-center w-12 text-right opacity-50">[{log.time.toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit'})}]</span>
                                            <div className="flex-1 flex gap-2 items-baseline">
                                                <span className={`font-bold uppercase text-[11px] tracking-wide ${log.type === 'crit' ? 'text-yellow-400' : log.type === 'fail' ? 'text-red-500' : 'text-blue-400'}`}>{log.title}:</span>
                                                <span className="text-white font-bold text-sm">{log.result}</span>
                                                <span className="text-gray-500 text-xs">- {log.detail}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>
                </div>

                <div className="text-center py-6 text-[10px] text-gray-600 font-mono uppercase tracking-widest opacity-50 flex items-center justify-center gap-2">
                     <Lock size={10} /> Schrodinger Corp. © 1999 • Hunter Association Database
                </div>

                {/* Char Modal */}
                {isCharModalOpen && (
                    <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                        <div className="tech-border bg-[#0a0a0c] w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl relative">
                            <div className="absolute inset-0 bg-hunter-pattern opacity-10 pointer-events-none"></div>
                            
                            <div className="p-6 border-b border-white/10 flex justify-between items-center bg-[#0e0e10]">
                                <h2 className="font-tech text-2xl text-white uppercase tracking-widest flex items-center gap-3"><Users size={24} className="text-theme"/> Acesso ao Banco de Dados</h2>
                                <button onClick={() => setIsCharModalOpen(false)} className="p-2 bg-white/5 hover:bg-white/10 rounded-full transition-colors z-20 relative"><X size={24} className="text-gray-400 hover:text-white"/></button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 relative z-10">
                                {characters.map(c => (
                                    <div key={c.id} onClick={() => { setActiveCharId(c.id); setIsCharModalOpen(false); }} className={`p-6 border cursor-pointer hover:bg-white/5 transition-all flex flex-col gap-3 relative group rounded-sm ${c.id === activeCharId ? 'border-theme bg-theme/5 shadow-[0_0_20px_rgba(155,89,182,0.1)]' : 'border-white/10'}`}>
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-title text-2xl text-white group-hover:text-theme transition-colors">{c.nickname}</h3>
                                            {c.id === activeCharId && <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#2ecc71]"></div>}
                                        </div>
                                        <div className="h-[1px] w-full bg-white/10 group-hover:bg-white/20 transition-colors"></div>
                                        <div className="flex justify-between items-end">
                                            <div className="flex flex-col">
                                                <span className="text-xs font-mono text-gray-400">{c.name}</span>
                                                <span className="text-[10px] text-gray-600 mt-1">Lvl {c.hunterLevel}</span>
                                            </div>
                                            <span className="text-[10px] uppercase font-bold text-gray-500 bg-black/30 px-2 py-1 rounded tracking-widest">{c.nenType.split(' ')[0]}</span>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => {
                                    const newChar = {...INITIAL_CHARACTER, id: Math.random().toString(36), nickname: 'Novo Hunter', name: 'Desconhecido'};
                                    handleStateUpdate(prev => [...prev, newChar]);
                                }} className="border-2 border-dashed border-white/10 flex flex-col items-center justify-center p-6 text-gray-600 hover:text-white hover:border-white/30 transition-all group rounded-sm hover:bg-white/5 relative z-20">
                                    <Plus size={32} className="mb-3 group-hover:scale-110 transition-transform text-theme opacity-50 group-hover:opacity-100"/> <span className="text-xs font-bold uppercase tracking-widest">Nova Ficha</span>
                                </button>
                            </div>
                            <div className="p-4 text-center text-[10px] text-gray-600 font-mono uppercase border-t border-white/10 bg-[#0e0e10] flex items-center justify-center gap-2">
                                <Lock size={10} /> Acesso Restrito • Schrodinger Corp.
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>