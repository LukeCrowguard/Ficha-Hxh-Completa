<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hunter Database | HxH RPG</title>
    
    <!-- SEO & Icons -->
    <meta name="description" content="Ficha de RPG Hunter x Hunter interativa. Gerencie atributos, Nen, invocações e inventário com cálculos automáticos.">
    <meta name="theme-color" content="#050506">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&family=Shojumaru&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser JSX/TS transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'hxh-dark': '#0a0a0c',
              'theme': 'var(--theme-color)',
            },
            fontFamily: {
              'title': ['Shojumaru', 'cursive'],
              'header': ['Cinzel', 'serif'],
              'tech': ['Orbitron', 'sans-serif'],
              'body': ['Lato', 'sans-serif'],
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out forwards',
              'blink': 'blink 2s step-end infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' }
              },
              blink: {
                '0%, 100%': { opacity: '1' },
                '50%': { opacity: '0.3' }
              }
            }
          }
        }
      }
    </script>
    
    <style>
      :root {
        --theme-color: #9b59b6;
      }
      body {
        background-color: #050506;
        color: #e0e0e0;
        overflow-x: hidden;
      }
      
      .bg-hunter-grid {
        background-size: 40px 40px;
        background-image:
          linear-gradient(to right, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
      }

      .glass-panel {
        background: rgba(13, 13, 16, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .tech-border {
        position: relative;
        border: 1px solid rgba(255,255,255,0.08);
        transition: border-color 0.3s;
      }
      .tech-border::before, .tech-border::after {
        content: '';
        position: absolute;
        width: 10px;
        height: 10px;
        border-color: var(--theme-color);
        border-style: solid;
        transition: all 0.3s;
        opacity: 0.8;
        box-shadow: 0 0 8px var(--theme-color);
        pointer-events: none;
      }
      .tech-border::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
      .tech-border::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
      .tech-border:hover { border-color: rgba(255,255,255,0.2); }

      .hunter-rune {
        font-family: 'Shojumaru', cursive;
        position: absolute;
        opacity: 0.05;
        pointer-events: none;
        user-select: none;
        color: white;
      }

      .avatar-frame {
        clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
      }
      
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0a0a0c; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react, typescript" data-type="module">
      import React, { useState, useRef, useEffect } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { 
        Shield, Zap, Heart, Sword, Brain, Activity, Ghost, Feather, Dna, 
        Dice5, Trash2, Edit3, Save, Plus, X, Camera, ScrollText, Box,
        Users, Upload, Share2, Copy, Hexagon,
        Monitor, Target, PawPrint, Terminal, ChevronRight, ImageIcon, BatteryCharging, Sparkles
      } from 'https://esm.sh/lucide-react@0.294.0';

      const utf8_to_b64 = (str) => window.btoa(unescape(encodeURIComponent(str)));
      const b64_to_utf8 = (str) => decodeURIComponent(escape(window.atob(str)));
      
      const rollDice = (diceStr) => {
        try {
            if(!diceStr) return 0;
            const [count, die] = diceStr.toLowerCase().split('d').map(Number);
            if(!count || !die) return 0;
            let total = 0;
            let rolls = [];
            for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * die) + 1;
                rolls.push(r);
                total += r;
            }
            return { total, rolls, str: diceStr };
        } catch (e) { return { total: 0, rolls: [], str: diceStr }; }
      };

      // Helper function to resize images before saving
      const resizeImage = (file, maxWidth = 600) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    // Export as JPEG with 70% quality to save space
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = (error) => reject(error);
            };
            reader.onerror = (error) => reject(error);
        });
      };

      const NenType = {
        Enhancer: 'Reforço',
        Transmuter: 'Transformação',
        Emitter: 'Emissão',
        Conjurer: 'Materialização',
        Manipulator: 'Manipulação',
        Specialist: 'Especialização',
      };

      const NEN_COLORS = {
        [NenType.Enhancer]: '#2ecc71', 
        [NenType.Transmuter]: '#d500f9', 
        [NenType.Emitter]: '#29b6f6',
        [NenType.Conjurer]: '#ff1744', 
        [NenType.Manipulator]: '#ff6d00', // ORANGE - Changed to differentiate from Enhancer
        [NenType.Specialist]: '#ffea00',
      };

      const INITIAL_CHARACTER = {
        id: 'char_default',
        name: "Cristian Martínez",
        nickname: "'Hades'",
        avatarUrl: "https://i.pinimg.com/736x/8e/46/64/8e4664440076a084c7873994c657a827.jpg", 
        age: 18,
        nationality: "Peruano",
        height: "1.72 m",
        weight: "64 kg",
        alignment: "Neutro-Neutro",
        bio: "Hades cresceu nas ruas de Meteor City...",
        hunterLevel: 5,
        xp: 250,
        maxXp: 600,
        nenType: NenType.Specialist, 
        maxHp: 34, currentHp: 34, maxNen: 58, currentNen: 33, ca: 15,
        attributes: { strength: -2, constitution: -2, intelligence: 0, charisma: -3, determination: 3, prestidigitation: 5 },
        attributeLabels: { strength: 'Força', constitution: 'Constituição', intelligence: 'Inteligência', charisma: 'Carisma', determination: 'Determinação', prestidigitation: 'Destreza' },
        equippedWeapon: { name: 'Foice de Nen', damage: '1d10', description: 'Uma foice materializada que drena aura.', powers: 'Ao acertar um crítico, recupera 1d4 de Nen.', imageUrl: '' },
        skills: [
            { id: '1', name: 'Força de Pulso', category: 'Weapon', type: 'Active', cost: 2, costType: 'Nen', damageDice: '1d8', attributeScaling: 'determination', description: 'Golpeia o ar criando uma onda de choque.', imageUrl: 'https://i.pinimg.com/564x/4d/2e/77/4d2e77987823e595df5057a151859c2c.jpg' },
            { id: '2', name: 'Passo Sombrio', category: 'Combat', type: 'Bonus', cost: 0, costType: 'Nen', damageDice: '2d6', attributeScaling: 'prestidigitation', description: 'Movimentação silenciosa. Vantagem no ataque.', imageUrl: '' },
            { id: '3', name: 'Sacrifício de Sangue', category: 'Hatsu', type: 'Active', cost: 5, costType: 'HP', damageDice: '3d6', attributeScaling: '', description: 'Sacrifica vitalidade para causar dano massivo.', imageUrl: '' },
        ],
        inventory: [
            { id: 'i1', name: "Espada Curta", quantity: 1 },
            { id: 'i2', name: "Poção de Cura", quantity: 2 },
            { id: 'i3', name: "Licença Hunter", quantity: 1 }
        ],
        summons: [
             { id: 's1', name: 'Guardião Sombrio', avatarUrl: 'https://i.pinimg.com/564x/0a/65/59/0a6559385b0451df6718d09794025171.jpg', type: 'Besta de Nen', currentHp: 20, maxHp: 20, currentNen: 10, maxNen: 10, attributes: { strength: 3, constitution: 2, intelligence: -2, charisma: -3, determination: 4, prestidigitation: 2 }, description: 'Um lobo feito de sombras.', skills: [
                 { id: 's1k1', name: 'Mordida Sombria', cost: 2, costType: 'Nen', damage: '1d6', description: 'Ataque rápido com as presas.' }
             ] }
        ],
        conditions: []
      };

      // --- COMPONENTS ---

      const StatBar = ({ label, current, max, color, icon, isEditing, onChange, onMaxChange }) => {
        const percentage = Math.min(100, Math.max(0, (current / max) * 100));
        return (
            <div className="flex flex-col w-full mb-3 group relative">
            <div className="flex justify-between items-end mb-1">
                <div className="flex items-center gap-2 text-white font-tech text-[10px] font-bold uppercase tracking-wider opacity-80">
                {icon && <span style={{color}}>{icon}</span>}
                <span className="text-gray-200">{label}</span>
                </div>
                <div className="flex items-center text-md font-bold font-mono">
                <input type="number" value={current} onChange={(e) => onChange && onChange(parseInt(e.target.value) || 0)} className="w-12 bg-transparent text-right outline-none border-b border-transparent hover:border-white/50 focus:border-white text-white font-bold" />
                <span className="mx-1 text-gray-500">/</span>
                {isEditing ? <input type="number" value={max} onChange={(e) => onMaxChange && onMaxChange(parseInt(e.target.value) || 0)} className="w-12 bg-white/10 rounded px-1 text-center outline-none border border-white/20 text-white"/> : <span className="text-gray-400 w-12 text-center">{max}</span>}
                </div>
            </div>
            <div className="relative h-3 bg-[#0a0a0c] overflow-hidden border border-white/10 skew-x-[-12deg] mx-1">
                <div className="absolute inset-0 bg-[linear-gradient(90deg,transparent_2px,#000_2px)] bg-[length:6px_100%] opacity-20 z-10"></div>
                <div className="h-full transition-all duration-700" style={{ width: `${percentage}%`, backgroundColor: color, boxShadow: `0 0 10px ${color}` }}></div>
            </div>
            </div>
        );
      };

      const AttributeCard = ({ label, value, icon: Icon, color, isEditing, onRoll, onChange, onLabelChange }) => {
        return (
            <div className="tech-border bg-[#131316] p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 transition-all group relative overflow-hidden" onClick={!isEditing ? onRoll : undefined}>
                <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div className="relative z-10 flex flex-col items-center">
                    <Icon size={24} style={{ color }} className="mb-2 drop-shadow-md group-hover:scale-110 transition-transform"/>
                    {isEditing ? (
                        <input type="number" value={value} onChange={(e) => onChange(parseInt(e.target.value) || 0)} className="w-12 bg-black/50 border-b border-white/30 text-center text-white font-mono text-xl outline-none"/>
                    ) : (
                        <span className="text-2xl font-mono font-bold text-white group-hover:text-theme transition-colors">{value >= 0 ? `+${value}` : value}</span>
                    )}
                    {isEditing ? (
                         <input value={label} onChange={e => onLabelChange(e.target.value)} className="text-[9px] font-tech uppercase tracking-widest text-gray-500 mt-1 bg-transparent border-b border-transparent hover:border-white/20 text-center w-full outline-none"/>
                    ) : (
                        <span className="text-[9px] font-tech uppercase tracking-widest text-gray-500 mt-1 truncate w-full text-center">{label}</span>
                    )}
                </div>
            </div>
        );
      };

      const AttributesRadar = ({ attributes, labels, size = 200, color }) => {
        const keys = ['strength', 'intelligence', 'charisma', 'determination', 'constitution', 'prestidigitation'];
        const displayLabels = labels || { strength: 'FOR', intelligence: 'INT', charisma: 'CAR', determination: 'DET', constitution: 'CON', prestidigitation: 'DES' };
        
        const ATTR_ICONS = {
            strength: Sword,
            intelligence: Brain,
            charisma: Feather,
            determination: Dna,
            constitution: Activity,
            prestidigitation: Ghost
        };

        const center = size / 2;
        const radius = size * 0.35; // slightly smaller to fit text
        const maxVal = 10; 
        const minVal = -2;
        const range = maxVal - minVal;

        const getPoint = (val, i) => {
            const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2;
            const normalized = Math.max(0, (Math.min(maxVal, val) - minVal) / range);
            const r = radius * normalized;
            return [center + Math.cos(angle) * r, center + Math.sin(angle) * r];
        };

        const polyPoints = keys.map((k, i) => getPoint(attributes[k], i).join(',')).join(' ');

        return (
            <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="overflow-visible">
                <defs>
                    <filter id="radar-glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                {/* Background Web */}
                {[0.2, 0.4, 0.6, 0.8, 1].map((scale, idx) => (
                    <polygon key={idx} points={keys.map((_, i) => {
                        const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2;
                        return `${center + Math.cos(angle) * radius * scale},${center + Math.sin(angle) * radius * scale}`;
                    }).join(' ')} fill="none" stroke="rgba(255,255,255,0.05)" strokeDasharray="2 2" />
                ))}
                {/* Axes & Labels */}
                {keys.map((k, i) => {
                     const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2;
                     const x = center + Math.cos(angle) * radius;
                     const y = center + Math.sin(angle) * radius;
                     
                     // Push labels out further to accommodate icons
                     const lx = center + Math.cos(angle) * (radius + 28);
                     const ly = center + Math.sin(angle) * (radius + 28);
                     
                     const labelText = displayLabels[k].substring(0, 3).toUpperCase();
                     const Icon = ATTR_ICONS[k];

                     return (
                        <g key={i}>
                            <line x1={center} y1={center} x2={x} y2={y} stroke="rgba(255,255,255,0.1)" />
                            {/* Icon Wrapper */}
                            <foreignObject x={lx - 10} y={ly - 20} width={20} height={20}>
                                <div className="flex items-center justify-center w-full h-full text-gray-500">
                                    <Icon size={14} />
                                </div>
                            </foreignObject>
                            {/* Label Text */}
                            <text x={lx} y={ly + 5} textAnchor="middle" dominantBaseline="middle" fill="#666" fontSize="8" className="font-tech font-bold">{labelText}</text>
                        </g>
                     )
                })}
                {/* Data Polygon */}
                <polygon points={polyPoints} fill={color} fillOpacity="0.2" stroke={color} strokeWidth="2" style={{filter: 'url(#radar-glow)'}} className="transition-all duration-500"/>
                {/* Data Points */}
                {keys.map((k, i) => {
                    const [x, y] = getPoint(attributes[k], i);
                    return <circle key={i} cx={x} cy={y} r="2" fill="#fff" />
                })}
            </svg>
        )
      };

      const NenHexagon = ({ activeType, size = 160 }) => {
        const typeOrder = [NenType.Enhancer, NenType.Transmuter, NenType.Conjurer, NenType.Specialist, NenType.Manipulator, NenType.Emitter];
        const points = [{ x: 50, y: 10, l:'Reforço' }, { x: 84.6, y: 30, l:'Trans.' }, { x: 84.6, y: 70, l:'Mat.' }, { x: 50, y: 90, l:'Esp.' }, { x: 15.4, y: 70, l:'Man.' }, { x: 15.4, y: 30, l:'Emis.' }];
        
        const getEfficiencies = (type) => {
            const index = typeOrder.indexOf(type);
            return typeOrder.map((t, i) => {
                if (type === NenType.Specialist) {
                    if (t === NenType.Specialist) return 1.0;
                    if (t === NenType.Conjurer || t === NenType.Manipulator) return 0.8;
                    if (t === NenType.Transmuter || t === NenType.Emitter) return 0.6;
                    if (t === NenType.Enhancer) return 0.4;
                    return 0;
                }
                if (t === NenType.Specialist) return 0.0;
                let dist = Math.abs(index - i);
                if (dist > 3) dist = 6 - dist;
                let eff = 1.0 - (dist * 0.2); 
                return Math.max(0, eff);
            });
        };

        const efficiencies = getEfficiencies(activeType);
        const activeColor = NEN_COLORS[activeType] || '#fff';
        const polyPoints = points.map((p, i) => {
            const eff = Math.max(0.1, efficiencies[i]);
            const x = 50 + (p.x - 50) * eff;
            const y = 50 + (p.y - 50) * eff;
            return `${x},${y}`;
        }).join(' ');

        return (
            <div className="relative flex items-center justify-center" style={{width: size, height: size}}>
                 <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible drop-shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                    <defs><filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                    <polygon points={points.map(p => `${p.x},${p.y}`).join(' ')} fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="0.5" strokeDasharray="2 2"/>
                    
                    {points.map((p, i) => (
                        <g key={i}>
                            <text x={p.x} y={p.y < 50 ? p.y - 5 : p.y + 12} textAnchor="middle" fontSize="6" fill={efficiencies[i] === 1 ? activeColor : '#555'} className="font-tech font-bold uppercase">{p.l}</text>
                            {/* Percentage Labels */}
                            <text x={p.x} y={p.y < 50 ? p.y - 12 : p.y + 18} textAnchor="middle" fontSize="4" fill={efficiencies[i] > 0 ? '#aaa' : '#333'} className="font-mono">{(efficiencies[i]*100).toFixed(0)}%</text>
                        </g>
                    ))}

                    <polygon points={polyPoints} fill={activeColor} fillOpacity="0.2" stroke={activeColor} strokeWidth="1.5" strokeLinejoin="round" style={{ filter: 'url(#glow)' }} className="transition-all duration-700"/>
                    {points.map((p, i) => {
                        const eff = Math.max(0.1, efficiencies[i]);
                        const x = 50 + (p.x - 50) * eff;
                        const y = 50 + (p.y - 50) * eff;
                        return <circle key={i} cx={x} cy={y} r={efficiencies[i] === 1 ? 2 : 1} fill={activeColor} />
                    })}
                </svg>
            </div>
        );
      }

      // --- MAIN APP ---

      const App = () => {
        const [loadedFromUrl, setLoadedFromUrl] = useState(false);
        const [showShareModal, setShowShareModal] = useState(false);
        const [logs, setLogs] = useState([]);
        const [characters, setCharacters] = useState(() => {
             try {
                const urlParams = new URLSearchParams(window.location.search);
                const sharedData = urlParams.get('data');
                if (sharedData) return JSON.parse(b64_to_utf8(sharedData));
             } catch(e) {}
             try {
                const saved = localStorage.getItem('hxh_chars');
                if (saved) return JSON.parse(saved);
             } catch(e) {}
             return [INITIAL_CHARACTER];
        });

        const [activeCharId, setActiveCharId] = useState(() => characters[0]?.id || 'char_default');
        const [isCharModalOpen, setIsCharModalOpen] = useState(false);
        const [isEditing, setIsEditing] = useState(false);
        const [activeTab, setActiveTab] = useState('hatsus');
        const [uploadTarget, setUploadTarget] = useState(null); 
        const fileInputRef = useRef(null);
        const logsEndRef = useRef(null);

        useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('data')) setLoadedFromUrl(true);
        }, []);

        useEffect(() => {
            if (!loadedFromUrl) {
                try {
                    localStorage.setItem('hxh_chars', JSON.stringify(characters));
                } catch(e) {
                    console.error("Storage limit reached:", e);
                    alert("Atenção: Limite de armazenamento local atingido! As alterações recentes podem não ser salvas. Tente remover imagens grandes ou personagens antigos.");
                }
            }
        }, [characters, loadedFromUrl]);

        useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

        const addLog = (title, result, detail, type = 'info') => {
            setLogs(prev => [...prev, { id: Math.random(), title, result, detail, type, time: new Date() }]);
        };

        const handleStateUpdate = (newCharsFn) => {
            if (loadedFromUrl) {
                if(confirm("Você está editando uma ficha compartilhada. Isso salvará uma cópia local.")) {
                    setLoadedFromUrl(false);
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else return;
            }
            setCharacters(prev => typeof newCharsFn === 'function' ? newCharsFn(prev) : newCharsFn);
        };

        const updateChar = (field, value) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, [field]: value } : c));
        const updateAttribute = (attr, val) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, attributes: { ...c.attributes, [attr]: val } } : c));
        const updateAttributeLabel = (attr, val) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, attributeLabels: { ...(c.attributeLabels || INITIAL_CHARACTER.attributeLabels), [attr]: val } } : c));
        const updateEquippedWeapon = (field, val) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, equippedWeapon: { ...(c.equippedWeapon || {}), [field]: val } } : c));

        const char = characters.find(c => c.id === activeCharId) || characters[0];
        const themeColor = char ? (NEN_COLORS[char.nenType] || '#9b59b6') : '#9b59b6';
        
        // Ensure default labels exist if old save data
        const attrLabels = char.attributeLabels || INITIAL_CHARACTER.attributeLabels;
        const equippedWeapon = char.equippedWeapon || { name: 'Desarmado', damage: '1d4', description: 'Ataques básicos.', powers: '', imageUrl: '' };

        const handleRollAttribute = (attrKey, value) => {
            if(isEditing) return;
            const label = attrLabels[attrKey];
            const d20 = Math.floor(Math.random() * 20) + 1;
            const total = d20 + value;
            addLog(`Teste de ${label}`, total, `[d20: ${d20}] ${value >= 0 ? '+' : ''}${value}`, total >= 20 ? 'crit' : total <= 1 ? 'fail' : 'info');
        };

        const handleRollWeapon = (weapon) => {
            if(isEditing) return;
            const roll = rollDice(weapon.damage);
            addLog(`Ataque: ${weapon.name}`, roll.total > 0 ? roll.total : '0', roll.str ? `[${roll.str}]: ${roll.rolls.join('+')}` : '', 'combat');
        };

        const handleRollSkill = (skill, sourceName) => {
            if(isEditing) return;
            const roll = rollDice(skill.damage || skill.damageDice);
            addLog(`Uso: ${skill.name} (${sourceName || 'Habilidade'})`, roll.total > 0 ? roll.total : 'Ativado', roll.str ? `[${roll.str}]: ${roll.rolls.join('+')}` : 'Efeito ativado', 'combat');
            
            if(skill.cost > 0) {
                 const costType = skill.costType || 'Nen';
                 if (costType === 'HP') {
                    if(char.currentHp > skill.cost) {
                        updateChar('currentHp', char.currentHp - skill.cost);
                        addLog('Custo Vital', `-${skill.cost} HP`, 'Sacrifício de vida', 'fail');
                    } else {
                        alert("Vida insuficiente!");
                    }
                 } else {
                     if(char.currentNen >= skill.cost) {
                         updateChar('currentNen', char.currentNen - skill.cost);
                     } else {
                         alert("Nen insuficiente!");
                     }
                 }
            }
        };

        const addItem = (type, parentId) => {
             if (type === 'skill') {
                const category = activeTab === 'hatsus' ? 'Hatsu' : activeTab === 'combat' ? 'Combat' : 'Weapon';
                const newSkill = { id: Math.random().toString(36), name: 'Nova Habilidade', category, type: 'Active', cost: 0, costType: 'Nen', damageDice: '1d6', description: 'Descrição...', imageUrl: '' };
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, skills: [...c.skills, newSkill] } : c));
             }
             if (type === 'item') {
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, inventory: [...c.inventory, {id: Math.random().toString(), name: 'Item', quantity: 1}] } : c));
             }
             if (type === 'summon') {
                 const newSummon = { id: Math.random().toString(36), name: 'Nova Invocação', avatarUrl: '', type: 'Besta de Nen', currentHp: 10, maxHp: 10, currentNen: 5, maxNen: 5, attributes: { strength: 0, constitution: 0, intelligence: 0, charisma: 0, determination: 0, prestidigitation: 0 }, description: 'Descrição...', skills: [] };
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: [...c.summons, newSummon] } : c));
             }
             if (type === 'summonSkill' && parentId) {
                const newSummonSkill = { id: Math.random().toString(36), name: 'Nova Habilidade', cost: 1, costType: 'Nen', damage: '1d4', description: 'Efeito...' };
                const newSummons = char.summons.map(s => s.id === parentId ? { ...s, skills: [...(s.skills || []), newSummonSkill] } : s);
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: newSummons } : c));
             }
        }
        
        const deleteItem = (collection, id, parentId) => {
             if (collection === 'summonSkill' && parentId) {
                 const newSummons = char.summons.map(s => s.id === parentId ? { ...s, skills: s.skills.filter(k => k.id !== id) } : s);
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: newSummons } : c));
             } else {
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, [collection]: c[collection].filter(i => i.id !== id) } : c));
             }
        }

        const copyLink = () => {
            const jsonStr = JSON.stringify(characters);
            const url = `${window.location.origin}${window.location.pathname}?data=${utf8_to_b64(jsonStr)}`;
            navigator.clipboard.writeText(url);
            alert("Link copiado!");
            setShowShareModal(false);
        };

        const triggerUpload = (target) => { 
            setUploadTarget(target);
            fileInputRef.current?.click();
        }

        const handleUpload = async (e) => {
            const file = e.target.files?.[0];
            if(file && uploadTarget) {
                try {
                    const res = await resizeImage(file);
                    
                    if (uploadTarget.type === 'avatar') {
                        updateChar('avatarUrl', res);
                    } else if (uploadTarget.type === 'skill' && uploadTarget.id) {
                        const newSkills = char.skills.map(s => s.id === uploadTarget.id ? {...s, imageUrl: res} : s);
                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                    } else if (uploadTarget.type === 'summon' && uploadTarget.id) {
                        const newSummons = char.summons.map(s => s.id === uploadTarget.id ? {...s, avatarUrl: res} : s);
                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                    } else if (uploadTarget.type === 'equippedWeapon') {
                        updateChar('equippedWeapon', { ...(char.equippedWeapon || {}), imageUrl: res });
                    }
                } catch (error) {
                    console.error("Error processing image:", error);
                    alert("Erro ao processar a imagem. Tente uma imagem menor.");
                } finally {
                    setUploadTarget(null);
                    // Reset input value to allow selecting the same file again if needed
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            }
        }

        if (!char) return <div className="text-white">Carregando...</div>;

        return (
            <div className="min-h-screen bg-[#050506] text-gray-200 font-body pb-12 overflow-x-hidden selection:text-black relative" style={{ '--theme-color': themeColor }}>
                
                {/* Background */}
                <div className="fixed inset-0 pointer-events-none z-0">
                    <div className="absolute inset-0 bg-[#050506]"></div>
                    <div className="absolute inset-0 bg-hunter-grid opacity-20"></div>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-[0.03] select-none font-title text-[30vw] text-white">HXH</div>
                </div>

                {/* BRANDING */}
                <div className="fixed bottom-4 left-4 z-40 flex items-center gap-2 pointer-events-none select-none animate-fade-in">
                    <Monitor size={16} className="text-gray-600" />
                    <div className="text-[10px] font-tech text-gray-600 uppercase tracking-[0.2em] flex items-center gap-2">
                        Schrodinger Corp. <span className="opacity-30">|</span> SYS.v4.9 <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-blink"></span>
                    </div>
                </div>

                <input type="file" ref={fileInputRef} className="hidden" onChange={handleUpload}/>

                {/* Navbar */}
                <div className="sticky top-0 z-50 bg-[#0a0a0c]/90 backdrop-blur-md border-b border-white/10 px-4 py-3 flex justify-between items-center shadow-lg">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 flex items-center justify-center bg-white/10 rounded border border-white/20">
                            <span className="font-title text-theme text-xl font-bold">H</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="font-tech text-[10px] font-bold tracking-[0.3em] text-gray-500 uppercase">Sistema Hunter</span>
                            <span className="font-bold text-white text-xs tracking-widest uppercase">{char.nickname}</span>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setShowShareModal(true)} className="p-2 text-gray-400 hover:text-white bg-white/5 rounded-full"><Share2 size={16}/></button>
                        <button onClick={() => setIsCharModalOpen(true)} className="p-2 text-gray-400 hover:text-white bg-white/5 rounded-full"><Users size={16}/></button>
                        <button onClick={() => setIsEditing(!isEditing)} className={`px-4 py-1.5 rounded text-[10px] font-bold uppercase tracking-wider border transition-all ${isEditing ? 'bg-white text-black border-white' : 'bg-transparent text-theme border-theme'}`}>
                            {isEditing ? 'Salvar' : 'Editar'}
                        </button>
                    </div>
                </div>

                {/* Share Modal */}
                {showShareModal && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur p-4">
                        <div className="glass-panel w-full max-w-sm p-6 text-center tech-border relative">
                            <button onClick={() => setShowShareModal(false)} className="absolute top-2 right-2 text-gray-500 hover:text-red-400 p-2"><X size={20}/></button>
                            <h3 className="text-xl font-tech text-white mb-2 uppercase tracking-widest">Acesso ao Banco de Dados</h3>
                            <button onClick={copyLink} className="w-full py-3 bg-white/10 hover:bg-white/20 border border-white/20 text-white font-bold uppercase tracking-wider flex items-center justify-center gap-2 mt-4">
                                <Copy size={16}/> Copiar Link
                            </button>
                        </div>
                    </div>
                )}

                {/* Main Content */}
                <div className="relative z-10 max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left Column: Avatar & Analysis */}
                    <div className="lg:col-span-4 flex flex-col gap-6">
                        {/* Avatar Card */}
                        <div className="relative bg-[#0a0a0c] avatar-frame shadow-2xl tech-border group">
                            <div className="h-96 w-full relative bg-gray-900 overflow-hidden">
                                <img src={char.avatarUrl} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-all duration-700"/>
                                <div className="absolute inset-0 bg-gradient-to-t from-[#0a0a0c] via-transparent to-transparent"></div>
                                {isEditing && <button onClick={() => triggerUpload({type:'avatar'})} className="absolute top-2 right-2 p-2 bg-black/50 text-white rounded hover:bg-white hover:text-black"><Upload size={16}/></button>}
                                <div className="absolute bottom-4 left-4 right-4">
                                    {isEditing ? <input value={char.nickname} onChange={e => updateChar('nickname', e.target.value)} className="bg-transparent border-b border-white/50 text-3xl font-title text-white w-full"/> : 
                                    <h1 className="text-4xl font-title text-white drop-shadow-lg" style={{textShadow: `0 0 10px ${themeColor}`}}>{char.nickname}</h1>}
                                    <span className="text-xs font-tech text-theme uppercase tracking-widest">{char.nenType}</span>
                                </div>
                            </div>
                            {/* XP Strip */}
                            <div className="bg-[#151518] px-4 py-2 border-t border-white/5 flex justify-between items-center font-mono text-[10px]">
                                <span className="text-gray-500">NÍVEL <span className="text-white text-sm">{char.hunterLevel}</span></span>
                                <div className="w-24 text-right">
                                    <span className="text-gray-500">{char.xp} / {char.maxXp} XP</span>
                                    <div className="w-full h-1 bg-gray-700 rounded-full mt-1 overflow-hidden"><div className="h-full bg-yellow-500" style={{width: `${(char.xp/char.maxXp)*100}%`}}></div></div>
                                </div>
                            </div>
                            {/* Personal Details */}
                            <div className="p-4 grid grid-cols-2 gap-y-3 text-xs font-mono bg-black/40">
                                {[{l:'Idade',k:'age'},{l:'Altura',k:'height'},{l:'Peso',k:'weight'},{l:'Nacionalidade',k:'nationality'}].map(f => (
                                    <div key={f.k}>
                                        <span className="text-gray-500 block text-[9px] uppercase tracking-wider">{f.l}</span>
                                        {isEditing ? <input value={char[f.k]} onChange={e => updateChar(f.k, e.target.value)} className="bg-transparent border-b border-white/20 text-white w-full"/> : <span className="text-white">{char[f.k]}</span>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Nen Analysis Card (Restored) */}
                        <div className="glass-panel p-6 tech-border flex flex-col items-center">
                            <div className="flex justify-between w-full items-center mb-4">
                                <span className="text-xs font-tech uppercase tracking-widest text-gray-500 flex items-center gap-2"><Hexagon size={14}/> Afinidade de Nen</span>
                                {isEditing && <select value={char.nenType} onChange={e => updateChar('nenType', e.target.value)} className="bg-black border border-white/20 text-white text-[10px] p-1 uppercase">{Object.keys(NenType).map(k => <option key={k} value={NenType[k]}>{NenType[k]}</option>)}</select>}
                            </div>
                            <NenHexagon activeType={char.nenType} size={180} />
                            <div className="mt-4 text-center">
                                <span className="text-2xl font-title text-white" style={{color: themeColor}}>{char.nenType.split(' ')[0]}</span>
                            </div>
                        </div>
                    </div>

                    {/* Right Column: Stats & Tabs */}
                    <div className="lg:col-span-8 flex flex-col gap-6">
                        {/* Vitals & Radar & Attributes */}
                        <div className="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-6">
                            
                            {/* Stats Column */}
                            <div className="flex flex-col gap-6">
                                <div className="glass-panel p-5 tech-border flex flex-col justify-center gap-4">
                                    <StatBar label="Pontos de Vida (HP)" current={char.currentHp} max={char.maxHp} color="#ef4444" icon={<Heart size={12}/>} isEditing={isEditing} onChange={v => updateChar('currentHp', v)} onMaxChange={v => updateChar('maxHp', v)} />
                                    <StatBar label="Pontos de Aura (Nen)" current={char.currentNen} max={char.maxNen} color={themeColor} icon={<Zap size={12}/>} isEditing={isEditing} onChange={v => updateChar('currentNen', v)} onMaxChange={v => updateChar('maxNen', v)} />
                                    <div className="mt-2 flex items-center justify-between bg-white/5 p-3 rounded border border-white/5">
                                        <div className="flex items-center gap-2"><Shield size={16} className="text-gray-400"/><span className="text-xs font-tech text-gray-400 uppercase tracking-widest">Defesa (CA)</span></div>
                                        {isEditing ? <input type="number" value={char.ca} onChange={e => updateChar('ca', parseInt(e.target.value))} className="w-12 bg-transparent text-white text-center font-bold text-2xl border-b border-white/20"/> : <span className="text-2xl font-bold text-white mr-2">{char.ca}</span>}
                                    </div>
                                </div>
                                <div className="glass-panel p-4 tech-border flex items-center justify-center">
                                    <AttributesRadar attributes={char.attributes} labels={attrLabels} size={150} color={themeColor} />
                                </div>
                            </div>
                            
                            {/* Attributes Grid */}
                            <div className="glass-panel p-3 tech-border">
                                <div className="grid grid-cols-3 gap-2 h-full content-start">
                                    <AttributeCard label={attrLabels.strength} value={char.attributes.strength} icon={Sword} color="#c0392b" isEditing={isEditing} onRoll={() => handleRollAttribute('strength', char.attributes.strength)} onChange={(v) => updateAttribute('strength', v)} onLabelChange={(v) => updateAttributeLabel('strength', v)} />
                                    <AttributeCard label={attrLabels.intelligence} value={char.attributes.intelligence} icon={Brain} color="#8e44ad" isEditing={isEditing} onRoll={() => handleRollAttribute('intelligence', char.attributes.intelligence)} onChange={(v) => updateAttribute('intelligence', v)} onLabelChange={(v) => updateAttributeLabel('intelligence', v)} />
                                    <AttributeCard label={attrLabels.charisma} value={char.attributes.charisma} icon={Feather} color="#27ae60" isEditing={isEditing} onRoll={() => handleRollAttribute('charisma', char.attributes.charisma)} onChange={(v) => updateAttribute('charisma', v)} onLabelChange={(v) => updateAttributeLabel('charisma', v)} />
                                    <AttributeCard label={attrLabels.determination} value={char.attributes.determination} icon={Dna} color="#f1c40f" isEditing={isEditing} onRoll={() => handleRollAttribute('determination', char.attributes.determination)} onChange={(v) => updateAttribute('determination', v)} onLabelChange={(v) => updateAttributeLabel('determination', v)} />
                                    <AttributeCard label={attrLabels.constitution} value={char.attributes.constitution} icon={Activity} color="#2980b9" isEditing={isEditing} onRoll={() => handleRollAttribute('constitution', char.attributes.constitution)} onChange={(v) => updateAttribute('constitution', v)} onLabelChange={(v) => updateAttributeLabel('constitution', v)} />
                                    <AttributeCard label={attrLabels.prestidigitation} value={char.attributes.prestidigitation} icon={Ghost} color="#e67e22" isEditing={isEditing} onRoll={() => handleRollAttribute('prestidigitation', char.attributes.prestidigitation)} onChange={(v) => updateAttribute('prestidigitation', v)} onLabelChange={(v) => updateAttributeLabel('prestidigitation', v)} />
                                </div>
                            </div>
                        </div>

                        {/* Tabs & Content */}
                        <div className="glass-panel tech-border flex flex-col min-h-[500px] relative">
                            <div className="flex bg-black/40 border-b border-white/10 overflow-x-auto">
                                {[
                                    {id: 'hatsus', label: 'Hatsus', icon: Zap},
                                    {id: 'combat', label: 'Combate', icon: Target},
                                    {id: 'weapon', label: 'Armas', icon: Sword},
                                    {id: 'summons', label: 'Invocações', icon: PawPrint},
                                    {id: 'inventory', label: 'Inventário', icon: Box},
                                    {id: 'bio', label: 'Bio', icon: ScrollText}
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-4 text-[10px] font-bold uppercase tracking-widest transition-colors border-b-2 ${activeTab === tab.id ? 'text-white border-theme bg-white/5' : 'text-gray-500 border-transparent hover:text-gray-300'}`}>
                                        <tab.icon size={14} /> {tab.label}
                                    </button>
                                ))}
                            </div>

                            <div className="p-6 flex-1 bg-gradient-to-b from-transparent to-black/20 overflow-y-auto">
                                {/* Skills Logic */}
                                {['hatsus', 'combat', 'weapon'].includes(activeTab) && (
                                    <div className="space-y-4">
                                        
                                        {/* Weapon Card (Specific to Weapon Tab) */}
                                        {activeTab === 'weapon' && (
                                            <div className="mb-6 tech-border bg-[#131316] p-4 relative group">
                                                 <h3 className="text-xs font-tech uppercase tracking-widest text-theme mb-4 flex items-center gap-2"><Sword size={14}/> Arma Equipada</h3>
                                                 <div className="flex flex-col md:flex-row gap-4">
                                                    {/* Weapon Image */}
                                                    <div className="w-full md:w-32 h-32 bg-black/40 relative border border-white/10 flex-shrink-0">
                                                        {equippedWeapon.imageUrl ? <img src={equippedWeapon.imageUrl} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-white/10"><Sword size={32}/></div>}
                                                         {isEditing && (
                                                            <button onClick={() => triggerUpload({type: 'equippedWeapon'})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity">
                                                                <Camera size={20}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                    {/* Weapon Details */}
                                                    <div className="flex-1 flex flex-col justify-between">
                                                        <div className="flex justify-between items-start">
                                                             <div className="flex-1">
                                                                 {isEditing ? <input className="bg-transparent border-b border-white/20 text-xl font-title text-white w-full mb-1" value={equippedWeapon.name} onChange={e => updateEquippedWeapon('name', e.target.value)} placeholder="Nome da Arma"/> : <h2 className="text-xl font-title text-white">{equippedWeapon.name}</h2>}
                                                             </div>
                                                             {/* Damage Roll Button */}
                                                             {!isEditing && equippedWeapon.damage && (
                                                                <button onClick={() => handleRollWeapon(equippedWeapon)} className="text-xs font-mono text-red-300 bg-red-900/20 px-2 py-1 border border-red-500/20 hover:bg-red-900/40 flex items-center gap-1 cursor-pointer transition-colors">
                                                                    <Dice5 size={12}/> {equippedWeapon.damage}
                                                                </button>
                                                             )}
                                                             {isEditing && <input className="bg-red-900/30 border border-red-500/30 text-xs text-red-300 w-20 px-2 py-1 text-center" placeholder="Dano" value={equippedWeapon.damage} onChange={e => updateEquippedWeapon('damage', e.target.value)} />}
                                                        </div>
                                                        <div className="mt-2 text-xs text-gray-400 font-serif leading-relaxed grid gap-2">
                                                            {/* Description */}
                                                            <div>
                                                                <span className="text-[9px] font-bold text-gray-500 uppercase">Visual & Lore</span>
                                                                {isEditing ? <textarea className="w-full bg-black/30 border border-white/10 p-2 h-16 resize-none mt-1 text-gray-300" value={equippedWeapon.description} onChange={e => updateEquippedWeapon('description', e.target.value)} placeholder="Descrição visual da arma..."/> : <p className="text-gray-300 mt-1">{equippedWeapon.description}</p>}
                                                            </div>
                                                            {/* Powers */}
                                                            <div>
                                                                <span className="text-[9px] font-bold text-gray-500 uppercase flex items-center gap-1"><Sparkles size={10}/> Poderes & Habilidades</span>
                                                                {isEditing ? <textarea className="w-full bg-black/30 border border-white/10 p-2 h-16 resize-none mt-1 text-blue-200" value={equippedWeapon.powers} onChange={e => updateEquippedWeapon('powers', e.target.value)} placeholder="Efeitos passivos, habilidades especiais..."/> : <p className="text-blue-200 mt-1 whitespace-pre-wrap">{equippedWeapon.powers || <span className="text-gray-600 italic">Nenhum poder especial.</span>}</p>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                 </div>
                                            </div>
                                        )}

                                        {activeTab === 'weapon' && <h3 className="text-[10px] font-bold uppercase text-gray-500 mb-2 mt-6 border-b border-white/10 pb-2 tracking-widest">Técnicas da Arma</h3>}

                                        {char.skills.filter(s => s.category.toLowerCase() === (activeTab === 'hatsus' ? 'hatsu' : activeTab)).length === 0 && <div className="text-gray-500 italic p-4 text-center border border-dashed border-white/10">Nenhuma habilidade registrada nesta categoria.</div>}
                                        {char.skills.filter(s => s.category.toLowerCase() === (activeTab === 'hatsus' ? 'hatsu' : activeTab)).map(skill => (
                                            <div key={skill.id} className="tech-border bg-[#131316] group hover:bg-white/5 transition-all relative overflow-hidden flex flex-col md:flex-row">
                                                
                                                {/* Skill Image Section */}
                                                <div className="w-full md:w-32 h-32 bg-black/40 relative flex-shrink-0 border-r border-white/10">
                                                    {skill.imageUrl ? 
                                                        <img src={skill.imageUrl} className="w-full h-full object-cover"/> 
                                                        : <div className="w-full h-full flex items-center justify-center text-white/10"><Hexagon size={40}/></div>
                                                    }
                                                    {isEditing && (
                                                        <button onClick={() => triggerUpload({type: 'skill', id: skill.id})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity">
                                                            <ImageIcon size={20}/>
                                                        </button>
                                                    )}
                                                </div>

                                                <div className="p-4 flex-1 flex flex-col justify-between">
                                                    <div className="flex justify-between items-start mb-2 relative z-10">
                                                        <div className="flex-1">
                                                            {isEditing ? (
                                                                <input className="bg-transparent border-b border-white/20 text-lg font-title text-white w-full mb-1" value={skill.name} onChange={e => {
                                                                    const newSkills = char.skills.map(s => s.id === skill.id ? {...s, name: e.target.value} : s);
                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                }} placeholder="Nome da Habilidade"/>
                                                            ) : (
                                                                <h4 className="font-title text-lg text-white group-hover:text-theme transition-colors cursor-pointer" onClick={() => handleRollSkill(skill)}>{skill.name}</h4>
                                                            )}
                                                            
                                                            <div className="flex gap-2 items-center mt-2 flex-wrap">
                                                                {isEditing ? (
                                                                    <>
                                                                        <input type="text" placeholder="Tipo" value={skill.type} onChange={e => {
                                                                            const newSkills = char.skills.map(s => s.id === skill.id ? {...s, type: e.target.value} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                        }} className="bg-black/50 border border-white/20 text-[10px] text-white w-24 px-1 py-1"/>
                                                                        
                                                                        <div className="flex items-center bg-black/50 border border-white/20 px-1 py-1">
                                                                            <input type="number" placeholder="Custo" value={skill.cost} onChange={e => {
                                                                                const newSkills = char.skills.map(s => s.id === skill.id ? {...s, cost: parseInt(e.target.value)} : s);
                                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                            }} className="bg-transparent text-[10px] text-white w-8 text-center outline-none"/>
                                                                            <select value={skill.costType || 'Nen'} onChange={e => {
                                                                                const newSkills = char.skills.map(s => s.id === skill.id ? {...s, costType: e.target.value} : s);
                                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                            }} className="bg-transparent text-[10px] text-gray-300 outline-none">
                                                                                <option value="Nen">Nen</option>
                                                                                <option value="HP">HP</option>
                                                                            </select>
                                                                        </div>

                                                                        <input type="text" placeholder="Dano" value={skill.damageDice} onChange={e => {
                                                                            const newSkills = char.skills.map(s => s.id === skill.id ? {...s, damageDice: e.target.value} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                                        }} className="bg-red-900/30 border border-red-500/30 text-[10px] text-red-300 w-16 px-1 py-1 text-center"/>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <span className="text-[9px] uppercase font-bold text-gray-400 border border-white/10 px-1 rounded">{skill.type}</span>
                                                                        {skill.cost > 0 && (
                                                                            <span className={`text-[9px] font-mono flex items-center gap-1 px-1.5 py-0.5 border ${skill.costType === 'HP' ? 'text-red-300 bg-red-900/20 border-red-500/20' : 'text-blue-300 bg-blue-900/20 border-blue-500/20'}`}>
                                                                                {skill.costType === 'HP' ? <Heart size={8}/> : <Zap size={8}/>} {skill.cost} {skill.costType === 'HP' ? 'HP' : 'AP'}
                                                                            </span>
                                                                        )}
                                                                        {skill.damageDice && <button onClick={() => handleRollSkill(skill)} className="text-[9px] font-mono text-red-300 bg-red-900/20 px-1.5 py-0.5 border border-red-500/20 hover:bg-red-900/40 flex items-center gap-1 cursor-pointer"><Dice5 size={10}/> {skill.damageDice}</button>}
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                        {isEditing && <button onClick={() => deleteItem('skills', skill.id)} className="text-red-500 hover:text-white p-1 bg-black/50 rounded"><Trash2 size={14}/></button>}
                                                    </div>
                                                    <div className="text-xs text-gray-400 font-serif pl-2 border-l border-white/10 leading-relaxed relative z-10 mt-2">
                                                        {isEditing ? <textarea value={skill.description} onChange={e => {
                                                            const newSkills = char.skills.map(s => s.id === skill.id ? {...s, description: e.target.value} : s);
                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, skills: newSkills} : c));
                                                        }} className="w-full bg-black/30 text-gray-300 p-2 h-16 resize-none border border-white/10"/> : skill.description}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('skill')} className="w-full py-4 border border-dashed border-white/10 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white hover:border-white transition-colors">+ Adicionar Técnica</button>}
                                    </div>
                                )}

                                {/* Inventory */}
                                {activeTab === 'inventory' && (
                                    <div className="grid grid-cols-1 gap-2">
                                        {char.inventory.map(item => (
                                            <div key={item.id} className="flex justify-between items-center p-3 bg-white/5 border border-white/5 hover:border-white/20 transition-all">
                                                <div className="flex items-center gap-3 flex-1">
                                                    <Box size={16} className="text-gray-500"/>
                                                    {isEditing ? <input value={item.name} onChange={e => {
                                                        const newInv = char.inventory.map(i => i.id === item.id ? {...i, name: e.target.value} : i);
                                                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, inventory: newInv} : c));
                                                    }} className="bg-transparent text-white border-b border-white/20 outline-none w-full"/> : <span className="font-mono text-sm text-gray-300">{item.name}</span>}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {isEditing ? <input type="number" value={item.quantity} onChange={e => {
                                                        const newInv = char.inventory.map(i => i.id === item.id ? {...i, quantity: parseInt(e.target.value)} : i);
                                                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, inventory: newInv} : c));
                                                    }} className="w-12 bg-black/30 text-center text-white border border-white/10"/> : <span className="font-mono text-xs text-theme bg-black/30 px-2 py-1 rounded">x{item.quantity}</span>}
                                                    {isEditing && <button onClick={() => deleteItem('inventory', item.id)} className="text-gray-600 hover:text-red-400"><Trash2 size={14}/></button>}
                                                </div>
                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('item')} className="w-full py-3 border border-dashed border-white/10 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors mt-2">+ Adicionar Item</button>}
                                    </div>
                                )}

                                {/* Summons */}
                                {activeTab === 'summons' && (
                                    <div className="grid grid-cols-1 gap-6">
                                        {char.summons.map(summon => (
                                            <div key={summon.id} className="tech-border bg-black/20 overflow-hidden group">
                                                {/* Header / Avatar Row */}
                                                <div className="flex flex-col md:flex-row border-b border-white/5">
                                                    <div className="w-full md:w-40 h-40 bg-black/40 relative flex-shrink-0 border-r border-white/10">
                                                        {summon.avatarUrl ? <img src={summon.avatarUrl} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-white/10"><PawPrint size={40}/></div>}
                                                        {isEditing && (
                                                            <button onClick={() => triggerUpload({type: 'summon', id: summon.id})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity">
                                                                <ImageIcon size={20}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="p-4 flex-1">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                {isEditing ? <input value={summon.name} onChange={e => {
                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, name: e.target.value} : s);
                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                }} className="bg-transparent border-b border-white/20 text-lg font-title text-white w-full"/> : <h4 className="font-bold text-white text-xl">{summon.name}</h4>}
                                                                
                                                                {isEditing ? <input value={summon.type} onChange={e => {
                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, type: e.target.value} : s);
                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                }} className="bg-black/30 border border-white/10 text-xs text-gray-400 w-full mt-1"/> : <span className="text-[10px] uppercase font-bold text-gray-500 mt-1 block">{summon.type}</span>}
                                                            </div>
                                                            {isEditing && <button onClick={() => deleteItem('summons', summon.id)} className="text-red-500 hover:text-white"><Trash2 size={16}/></button>}
                                                        </div>
                                                        
                                                        {/* Description */}
                                                        {isEditing ? <textarea value={summon.description} onChange={e => {
                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, description: e.target.value} : s);
                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                        }} className="w-full h-20 bg-black/30 text-xs text-gray-400 p-2 border border-white/10 resize-none"/> : <p className="text-xs text-gray-400 italic line-clamp-3">"{summon.description}"</p>}
                                                    </div>
                                                </div>
                                                
                                                {/* Stats & Radar Row */}
                                                <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-6 bg-black/30 border-b border-white/5">
                                                    <div className="flex flex-col justify-center">
                                                        <StatBar label="HP" current={summon.currentHp} max={summon.maxHp} color="#ef4444" icon={<Heart size={10}/>} isEditing={isEditing}
                                                            onChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, currentHp: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                            onMaxChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, maxHp: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                        />
                                                        <StatBar label="Nen" current={summon.currentNen} max={summon.maxNen} color={themeColor} icon={<Zap size={10}/>} isEditing={isEditing}
                                                             onChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, currentNen: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                            onMaxChange={v => {
                                                                const newSummons = char.summons.map(s => s.id === summon.id ? {...s, maxNen: v} : s);
                                                                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                            }}
                                                        />
                                                    </div>
                                                    <div className="flex items-center justify-center relative">
                                                        <div className="scale-75 origin-center">
                                                            <AttributesRadar attributes={summon.attributes} size={150} color={themeColor} />
                                                        </div>
                                                        {isEditing && (
                                                            <div className="absolute inset-0 bg-black/80 flex flex-wrap content-center justify-center gap-1 p-2 overflow-y-auto">
                                                                {Object.entries(summon.attributes).map(([key, val]) => (
                                                                    <div key={key} className="flex flex-col items-center bg-white/10 p-1 w-14">
                                                                        <span className="text-[8px] uppercase">{key.substring(0,3)}</span>
                                                                        <input type="number" value={val} onChange={e => {
                                                                            const newAttrs = {...summon.attributes, [key]: parseInt(e.target.value) || 0};
                                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, attributes: newAttrs} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                        }} className="w-full bg-transparent text-center text-white text-xs"/>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Summon Skills Section */}
                                                <div className="p-4 bg-[#111]">
                                                    <div className="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-2 border-b border-white/10 pb-1 flex justify-between items-center">
                                                        <span>Habilidades da Invocação</span>
                                                        {isEditing && <button onClick={() => addItem('summonSkill', summon.id)} className="text-theme hover:text-white flex items-center gap-1"><Plus size={10}/> Add</button>}
                                                    </div>
                                                    <div className="space-y-2">
                                                        {(!summon.skills || summon.skills.length === 0) && <div className="text-xs text-gray-600 italic text-center py-2">Sem habilidades.</div>}
                                                        {(summon.skills || []).map(skill => (
                                                            <div key={skill.id} className="bg-black/40 border border-white/5 p-2 rounded flex flex-col gap-1">
                                                                <div className="flex justify-between items-center">
                                                                    <div className="flex items-center gap-2 flex-1">
                                                                        {isEditing ? <input value={skill.name} onChange={e => {
                                                                            const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, name: e.target.value} : s);
                                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                        }} className="bg-transparent border-b border-white/20 text-xs font-bold text-white w-full"/> : <span className="text-xs font-bold text-white cursor-pointer hover:text-theme" onClick={() => handleRollSkill(skill, summon.name)}>{skill.name}</span>}
                                                                    </div>
                                                                    <div className="flex items-center gap-2">
                                                                        {isEditing ? (
                                                                             <div className="flex items-center gap-1">
                                                                                <input type="number" value={skill.cost} onChange={e => {
                                                                                    const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, cost: parseInt(e.target.value)} : s);
                                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                                }} className="w-6 text-[10px] bg-white/10 text-center"/>
                                                                                 <select value={skill.costType || 'Nen'} onChange={e => {
                                                                                    const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, costType: e.target.value} : s);
                                                                                    const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                                    handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                                }} className="text-[10px] bg-black text-gray-400">
                                                                                    <option value="Nen">AP</option>
                                                                                    <option value="HP">HP</option>
                                                                                </select>
                                                                             </div>
                                                                        ) : (
                                                                            skill.cost > 0 && <span className={`text-[9px] font-mono px-1 rounded ${skill.costType === 'HP' ? 'text-red-400 bg-red-900/20' : 'text-blue-400 bg-blue-900/20'}`}>{skill.cost} {skill.costType === 'HP' ? 'HP' : 'AP'}</span>
                                                                        )}
                                                                        
                                                                        {isEditing ? <input value={skill.damage} onChange={e => {
                                                                            const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, damage: e.target.value} : s);
                                                                            const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                            handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                        }} className="w-10 text-[10px] bg-red-900/30 text-red-200 text-center" placeholder="Dano"/> : 
                                                                        (skill.damage && <button onClick={() => handleRollSkill(skill, summon.name)} className="text-[9px] text-red-300 flex items-center gap-1 hover:bg-white/5 px-1 rounded"><Dice5 size={8}/> {skill.damage}</button>)}

                                                                        {isEditing && <button onClick={() => deleteItem('summonSkill', skill.id, summon.id)} className="text-gray-600 hover:text-red-500"><Trash2 size={12}/></button>}
                                                                    </div>
                                                                </div>
                                                                <div className="text-[10px] text-gray-400 border-l-2 border-white/10 pl-2">
                                                                     {isEditing ? <textarea value={skill.description} onChange={e => {
                                                                        const newSkills = summon.skills.map(s => s.id === skill.id ? {...s, description: e.target.value} : s);
                                                                        const newSummons = char.summons.map(s => s.id === summon.id ? {...s, skills: newSkills} : s);
                                                                        handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? {...c, summons: newSummons} : c));
                                                                    }} className="w-full bg-transparent text-gray-400 resize-none h-8"/> : skill.description}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('summon')} className="w-full py-3 border border-dashed border-white/10 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors">+ Adicionar Invocação</button>}
                                    </div>
                                )}

                                {/* Bio */}
                                {activeTab === 'bio' && (
                                    isEditing ? <textarea className="w-full h-96 bg-black/20 border border-white/10 p-4 text-gray-300 font-serif leading-loose outline-none resize-none" value={char.bio} onChange={e => updateChar('bio', e.target.value)} /> :
                                    <p className="font-serif text-gray-300 leading-8 text-lg whitespace-pre-wrap">{char.bio}</p>
                                )}
                            </div>

                             {/* Console Log Overlay (Bottom of Tab) */}
                             <div className="absolute bottom-0 left-0 right-0 max-h-40 overflow-y-auto bg-black/90 border-t border-white/10 p-2 font-mono text-[10px] pointer-events-auto">
                                <div className="flex items-center justify-between mb-1 sticky top-0 bg-black/90 w-full z-10">
                                    <span className="flex items-center gap-2 text-gray-500"><Terminal size={10}/> Console de Batalha</span>
                                    <button onClick={() => {
                                        updateChar('currentHp', Math.min(char.maxHp, char.currentHp + 5));
                                        updateChar('currentNen', Math.min(char.maxNen, char.currentNen + 10));
                                        addLog('Descanso Curto', 'Recuperado', '+5 HP, +10 AP');
                                    }} className="text-[9px] text-green-400 hover:text-green-300 flex items-center gap-1"><BatteryCharging size={10}/> Descansar</button>
                                </div>
                                {logs.length === 0 && <div className="text-gray-700 italic pl-4">Aguardando rolagens...</div>}
                                {logs.map(log => (
                                    <div key={log.id} className="flex gap-2 mb-1 animate-fade-in">
                                        <span className="text-gray-600">[{log.time.toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit'})}]</span>
                                        <span className={log.type === 'crit' ? 'text-yellow-400 font-bold' : log.type === 'fail' ? 'text-red-500' : 'text-blue-300'}>{log.title}:</span>
                                        <span className="text-white font-bold">{log.result}</span>
                                        <span className="text-gray-500">{log.detail}</span>
                                    </div>
                                ))}
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>
                </div>

                {/* Char Modal */}
                {isCharModalOpen && (
                    <div className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4">
                        <div className="tech-border bg-[#0a0a0c] w-full max-w-4xl h-[80vh] flex flex-col">
                            <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                <h2 className="font-tech text-xl text-white uppercase tracking-widest flex items-center gap-2"><Users size={20} className="text-theme"/> Acesso ao Banco de Dados</h2>
                                <button onClick={() => setIsCharModalOpen(false)} className="p-2 bg-white/5 hover:bg-white/10 rounded-full"><X size={24} className="text-gray-400 hover:text-red-500 transition-colors"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {characters.map(c => (
                                    <div key={c.id} onClick={() => { setActiveCharId(c.id); setIsCharModalOpen(false); }} className={`p-4 border cursor-pointer hover:bg-white/5 transition-all flex flex-col gap-2 relative ${c.id === activeCharId ? 'border-theme bg-white/5' : 'border-white/10'}`}>
                                        <h3 className="font-title text-lg text-white">{c.nickname}</h3>
                                        <span className="text-xs font-mono text-gray-500">{c.name} • Lvl {c.hunterLevel}</span>
                                        <span className="text-[10px] uppercase font-bold text-theme">{c.nenType}</span>
                                        {c.id === activeCharId && <div className="absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>}
                                    </div>
                                ))}
                                <button onClick={() => {
                                    const newChar = {...INITIAL_CHARACTER, id: Math.random().toString(36), nickname: 'Novo Hunter', name: 'Desconhecido'};
                                    handleStateUpdate(prev => [...prev, newChar]);
                                }} className="border border-dashed border-white/20 flex flex-col items-center justify-center p-4 text-gray-500 hover:text-white transition-colors">
                                    <Plus size={24} className="mb-2"/> <span className="text-xs font-bold uppercase">Nova Ficha</span>
                                </button>
                            </div>
                            <div className="p-2 text-center text-[10px] text-gray-600 font-mono uppercase border-t border-white/10">Acesso Restrito • Schrodinger Corp.</div>
                        </div>
                    </div>
                )}
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>